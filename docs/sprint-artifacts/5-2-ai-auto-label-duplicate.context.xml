<?xml version="1.0" encoding="UTF-8"?>
<story-context story="5-2-ai-auto-label-duplicate" generated="2025-11-29">
  <!-- Story Context for AI Auto Label, Priority Suggestion & Duplicate Detection -->

  <story-metadata>
    <title>AI 자동 라벨/우선순위 추천 및 중복 이슈 탐지</title>
    <epic>Epic 5 - AI &amp; 대시보드 &amp; 알림</epic>
    <fr-coverage>FR-042, FR-043, FR-044</fr-coverage>
    <priority>P1</priority>
    <estimated-points>5</estimated-points>
  </story-metadata>

  <acceptance-criteria>
    <!-- FR-042: 라벨/우선순위 자동 제안 -->
    <criterion id="AC-042-1">이슈 생성/편집 시 "AI 라벨 제안" 버튼 표시</criterion>
    <criterion id="AC-042-2">제안된 라벨 목록에서 선택하여 적용 가능</criterion>
    <criterion id="AC-042-3">제안 라벨은 신뢰도 점수와 함께 표시</criterion>
    <criterion id="AC-042-4">이슈 생성 시 AI가 우선순위 제안</criterion>
    <criterion id="AC-042-5">제안된 우선순위를 원클릭으로 적용 가능</criterion>
    <criterion id="AC-042-6">사용자가 수동으로 변경 가능</criterion>
    <!-- FR-043: AI Rate Limiting -->
    <criterion id="AC-043-1">분당 10회 초과 시 429 에러 반환</criterion>
    <criterion id="AC-043-2">일당 100회 초과 시 429 에러 반환</criterion>
    <criterion id="AC-043-3">남은 사용량 UI에 표시 (선택)</criterion>
    <criterion id="AC-043-4">제한 초과 시 친절한 안내 메시지 표시</criterion>
    <!-- FR-044: 중복 이슈 탐지 -->
    <criterion id="AC-044-1">이슈 생성 시 유사도 80% 이상 이슈 경고</criterion>
    <criterion id="AC-044-2">중복 의심 이슈 클릭 시 해당 이슈로 이동</criterion>
    <criterion id="AC-044-3">사용자가 무시하고 생성 진행 가능</criterion>
  </acceptance-criteria>

  <technical-specification>
    <architecture>
      <decision id="ADR-005">API Route Handlers - AI 호출은 Route Handler로 구현</decision>
      <decision id="ADR-006">Server-Side OpenAI - AI 호출은 서버에서만 (API key 보호)</decision>
    </architecture>

    <api-endpoints>
      <endpoint method="POST" path="/api/ai/suggest">
        <description>라벨/우선순위 자동 제안 (FR-042)</description>
        <request>
          <![CDATA[
{
  issue_id?: string,  // 기존 이슈 수정 시
  title: string,
  description: string,
  project_id: string,  // 프로젝트 라벨 목록 조회용
  suggest_type: 'labels' | 'priority' | 'both'
}
          ]]>
        </request>
        <response>
          <![CDATA[
{
  success: true,
  data: {
    labels?: Array<{
      label_id: string,
      name: string,
      color: string,
      confidence: number  // 0-1
    }>,
    priority?: {
      value: 'LOW' | 'MEDIUM' | 'HIGH',
      confidence: number,
      reason: string
    }
  }
}
          ]]>
        </response>
      </endpoint>

      <endpoint method="POST" path="/api/ai/duplicate">
        <description>중복 이슈 탐지 (FR-044)</description>
        <request>
          <![CDATA[
{
  title: string,
  description: string,
  project_id: string
}
          ]]>
        </request>
        <response>
          <![CDATA[
{
  success: true,
  data: {
    duplicates: Array<{
      issue_id: string,
      issue_key: string,
      title: string,
      similarity: number  // 0-1 (0.8 이상 시 경고)
    }>
  }
}
          ]]>
        </response>
        <notes>
          <item>실시간 탐지: 제목/설명 입력 중 debounce 500ms 후 자동 호출</item>
          <item>유사도 80% 이상인 이슈만 반환</item>
        </notes>
      </endpoint>

      <endpoint method="GET" path="/api/ai/rate-limit">
        <description>현재 사용자의 AI Rate Limit 상태 조회</description>
        <response>
          <![CDATA[
{
  success: true,
  data: {
    minute_remaining: number,  // 분당 남은 횟수
    minute_reset_in: number,   // 초 단위 리셋 시간
    daily_remaining: number,   // 일당 남은 횟수
    daily_reset_in: number     // 초 단위 리셋 시간
  }
}
          ]]>
        </response>
      </endpoint>
    </api-endpoints>

    <data-models>
      <model name="ai_rate_limits">
        <description>AI 사용량 제한 테이블 (이미 스키마에 존재)</description>
        <columns>
          <column name="user_id" type="UUID" primary="true"/>
          <column name="minute_count" type="INTEGER" default="0"/>
          <column name="minute_reset_at" type="TIMESTAMPTZ"/>
          <column name="daily_count" type="INTEGER" default="0"/>
          <column name="daily_reset_at" type="TIMESTAMPTZ"/>
        </columns>
      </model>

      <model name="labels">
        <description>프로젝트 라벨 테이블 (이미 스키마에 존재)</description>
        <columns>
          <column name="id" type="UUID" primary="true"/>
          <column name="project_id" type="UUID" references="projects.id"/>
          <column name="name" type="string"/>
          <column name="color" type="string"/>
        </columns>
      </model>
    </data-models>

    <rate-limit-logic>
      <![CDATA[
// lib/ai/rate-limiter.ts
const LIMITS = {
  PER_MINUTE: 10,
  PER_DAY: 100
}

export async function checkRateLimit(userId: string): Promise<boolean> {
  const supabase = await createClient()
  const now = new Date()

  // 현재 rate limit 상태 조회
  const { data: rateLimit } = await supabase
    .from('ai_rate_limits')
    .select('*')
    .eq('user_id', userId)
    .single()

  if (!rateLimit) {
    // 첫 사용자: 레코드 생성
    await supabase.from('ai_rate_limits').insert({
      user_id: userId,
      minute_count: 0,
      minute_reset_at: new Date(now.getTime() + 60000).toISOString(),
      daily_count: 0,
      daily_reset_at: new Date(now.getTime() + 86400000).toISOString()
    })
    return true
  }

  // 분당 리셋 확인
  if (rateLimit.minute_reset_at && new Date(rateLimit.minute_reset_at) <= now) {
    await supabase.from('ai_rate_limits').update({
      minute_count: 0,
      minute_reset_at: new Date(now.getTime() + 60000).toISOString()
    }).eq('user_id', userId)
    rateLimit.minute_count = 0
  }

  // 일당 리셋 확인
  if (rateLimit.daily_reset_at && new Date(rateLimit.daily_reset_at) <= now) {
    await supabase.from('ai_rate_limits').update({
      daily_count: 0,
      daily_reset_at: new Date(now.getTime() + 86400000).toISOString()
    }).eq('user_id', userId)
    rateLimit.daily_count = 0
  }

  return rateLimit.minute_count < LIMITS.PER_MINUTE &&
         rateLimit.daily_count < LIMITS.PER_DAY
}

export async function recordUsage(userId: string, actionType: string): Promise<void> {
  const supabase = await createClient()
  await supabase.rpc('increment_ai_usage', { p_user_id: userId })
}
      ]]>
    </rate-limit-logic>
  </technical-specification>

  <implementation-guide>
    <file-structure>
      <![CDATA[
jira-lite-mvp/
├── app/
│   └── api/
│       └── ai/
│           ├── suggest/
│           │   └── route.ts        # POST /api/ai/suggest
│           ├── duplicate/
│           │   └── route.ts        # POST /api/ai/duplicate
│           └── rate-limit/
│               └── route.ts        # GET /api/ai/rate-limit
├── components/
│   └── ai/
│       ├── AILabelSuggestion.tsx   # 라벨 제안 컴포넌트
│       ├── AIPrioritySuggestion.tsx # 우선순위 제안 컴포넌트
│       ├── DuplicateWarning.tsx    # 중복 이슈 경고 컴포넌트
│       ├── RateLimitStatus.tsx     # Rate Limit 상태 표시
│       └── index.ts
├── lib/
│   └── ai/
│       ├── rate-limiter.ts         # Rate Limiting 로직
│       └── prompts.ts              # AI 프롬프트 (확장)
└── hooks/
    ├── use-ai-suggest.ts           # AI 제안 훅
    └── use-duplicate-check.ts      # 중복 체크 훅 (debounce)
      ]]>
    </file-structure>

    <component-specs>
      <component name="AILabelSuggestion">
        <location>components/ai/AILabelSuggestion.tsx</location>
        <props>
          <![CDATA[
interface AILabelSuggestionProps {
  projectId: string
  title: string
  description: string
  selectedLabels: string[]  // 현재 선택된 라벨 ID 목록
  onLabelSelect: (labelId: string) => void
  onLabelsApply: (labelIds: string[]) => void
}
          ]]>
        </props>
        <features>
          <item>"AI 라벨 추천" 버튼</item>
          <item>추천 라벨 목록 (신뢰도 퍼센트 표시)</item>
          <item>라벨 클릭으로 개별 추가</item>
          <item>"모두 적용" 버튼</item>
          <item>이미 선택된 라벨은 비활성화 표시</item>
        </features>
      </component>

      <component name="AIPrioritySuggestion">
        <location>components/ai/AIPrioritySuggestion.tsx</location>
        <props>
          <![CDATA[
interface AIPrioritySuggestionProps {
  title: string
  description: string
  currentPriority: 'LOW' | 'MEDIUM' | 'HIGH'
  onPriorityChange: (priority: 'LOW' | 'MEDIUM' | 'HIGH') => void
}
          ]]>
        </props>
        <features>
          <item>"AI 우선순위 추천" 버튼</item>
          <item>추천 우선순위 + 이유 표시</item>
          <item>"적용" 버튼으로 우선순위 변경</item>
          <item>신뢰도 표시</item>
        </features>
      </component>

      <component name="DuplicateWarning">
        <location>components/ai/DuplicateWarning.tsx</location>
        <props>
          <![CDATA[
interface DuplicateWarningProps {
  projectId: string
  title: string
  description: string
  onDuplicateClick: (issueId: string) => void
  onIgnore: () => void
}
          ]]>
        </props>
        <features>
          <item>중복 의심 이슈 경고 배너</item>
          <item>유사도 퍼센트 표시</item>
          <item>이슈 제목 클릭으로 해당 이슈 열기</item>
          <item>"무시하고 계속" 버튼</item>
          <item>debounce 500ms로 자동 체크</item>
        </features>
      </component>

      <component name="RateLimitStatus">
        <location>components/ai/RateLimitStatus.tsx</location>
        <props>
          <![CDATA[
interface RateLimitStatusProps {
  variant?: 'inline' | 'tooltip' | 'badge'
}
          ]]>
        </props>
        <features>
          <item>분당/일당 남은 사용량 표시</item>
          <item>리셋까지 남은 시간 카운트다운</item>
          <item>한도 초과 시 경고 스타일</item>
        </features>
      </component>
    </component-specs>

    <code-samples>
      <sample name="prompts.ts">
        <![CDATA[
// lib/ai/prompts.ts
export const PROMPTS = {
  LABEL_SUGGEST: `You are a software issue classifier.
Given the issue title and description, suggest appropriate labels from the available list.
Return JSON: { "suggestions": [{ "label_name": "...", "confidence": 0.0-1.0 }] }
Maximum 3 labels. Only suggest labels from the provided list.`,

  PRIORITY_SUGGEST: `You are a software issue priority analyzer.
Analyze the urgency and impact of the issue.
Return JSON: { "priority": "LOW|MEDIUM|HIGH", "confidence": 0.0-1.0, "reason": "..." }
Consider: security issues = HIGH, bugs affecting users = MEDIUM/HIGH, enhancements = LOW/MEDIUM`,

  DUPLICATE_DETECT: `You are a duplicate issue detector.
Compare the new issue with existing issues and identify potential duplicates.
Return JSON: { "duplicates": [{ "issue_id": "...", "similarity": 0.0-1.0 }] }
Only return issues with similarity >= 0.8`
}
        ]]>
      </sample>

      <sample name="duplicate-check-hook">
        <![CDATA[
// hooks/use-duplicate-check.ts
import { useState, useEffect } from 'react'
import { useDebouncedCallback } from 'use-debounce'

interface DuplicateResult {
  issue_id: string
  issue_key: string
  title: string
  similarity: number
}

export function useDuplicateCheck(
  projectId: string,
  title: string,
  description: string
) {
  const [duplicates, setDuplicates] = useState<DuplicateResult[]>([])
  const [isChecking, setIsChecking] = useState(false)

  const checkDuplicates = useDebouncedCallback(async () => {
    if (title.length < 5 || !projectId) return

    setIsChecking(true)
    try {
      const response = await fetch('/api/ai/duplicate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ project_id: projectId, title, description })
      })

      if (response.ok) {
        const result = await response.json()
        setDuplicates(result.data.duplicates || [])
      }
    } catch (error) {
      console.error('Duplicate check failed:', error)
    } finally {
      setIsChecking(false)
    }
  }, 500)

  useEffect(() => {
    checkDuplicates()
  }, [title, description, projectId])

  return { duplicates, isChecking, hasDuplicates: duplicates.length > 0 }
}
        ]]>
      </sample>

      <sample name="api-route-suggest">
        <![CDATA[
// app/api/ai/suggest/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { openai } from '@/lib/ai/openai-client'
import { checkRateLimit, recordUsage } from '@/lib/ai/rate-limiter'
import { PROMPTS } from '@/lib/ai/prompts'

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      return NextResponse.json(
        { success: false, error: { code: 'UNAUTHORIZED', message: '로그인이 필요합니다' } },
        { status: 401 }
      )
    }

    const canProceed = await checkRateLimit(user.id)
    if (!canProceed) {
      return NextResponse.json(
        { success: false, error: { code: 'RATE_LIMIT_EXCEEDED', message: 'AI 사용 한도를 초과했습니다' } },
        { status: 429 }
      )
    }

    const { title, description, project_id, suggest_type } = await request.json()

    const result: any = {}

    if (suggest_type === 'labels' || suggest_type === 'both') {
      // 프로젝트 라벨 목록 조회
      const { data: labels } = await supabase
        .from('labels')
        .select('id, name, color')
        .eq('project_id', project_id)

      const labelNames = labels?.map(l => l.name).join(', ') || ''

      const response = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: PROMPTS.LABEL_SUGGEST + `\nAvailable labels: ${labelNames}` },
          { role: 'user', content: `Title: ${title}\nDescription: ${description || 'N/A'}` }
        ],
        response_format: { type: 'json_object' }
      })

      const labelResult = JSON.parse(response.choices[0].message.content || '{}')
      result.labels = labelResult.suggestions?.map((s: any) => {
        const label = labels?.find(l => l.name === s.label_name)
        return label ? { ...label, confidence: s.confidence } : null
      }).filter(Boolean)
    }

    if (suggest_type === 'priority' || suggest_type === 'both') {
      const response = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: PROMPTS.PRIORITY_SUGGEST },
          { role: 'user', content: `Title: ${title}\nDescription: ${description || 'N/A'}` }
        ],
        response_format: { type: 'json_object' }
      })

      result.priority = JSON.parse(response.choices[0].message.content || '{}')
    }

    await recordUsage(user.id, 'suggest')

    return NextResponse.json({ success: true, data: result })

  } catch (error) {
    console.error('AI Suggest Error:', error)
    return NextResponse.json(
      { success: false, error: { code: 'AI_ERROR', message: 'AI 제안 생성에 실패했습니다' } },
      { status: 500 }
    )
  }
}
        ]]>
      </sample>
    </code-samples>
  </implementation-guide>

  <ux-design-reference>
    <design-system>
      <framework>shadcn/ui + Tailwind CSS + Radix UI</framework>
      <icons>Lucide Icons</icons>
    </design-system>

    <color-theme name="Linear Productivity">
      <primary>#5B5FC7 (Indigo)</primary>
      <accent>#3B82F6 (Blue)</accent>
      <ai-gradient>linear-gradient(135deg, #5B5FC7 0%, #3B82F6 100%)</ai-gradient>
      <success>#22C55E</success>
      <warning>#F59E0B</warning>
      <error>#EF4444</error>
    </color-theme>

    <label-tag-design>
      <![CDATA[
<!-- 라벨 태그 스타일 (ux-color-themes.html 참조) -->
.label-tag {
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.label-bug {
  background: #FEE2E2;
  color: #DC2626;
}

.label-feature {
  background: #DBEAFE;
  color: #2563EB;
}

.label-enhancement {
  background: #F3E8FF;
  color: #7C3AED;
}
      ]]>
    </label-tag-design>

    <priority-badge-design>
      <![CDATA[
<!-- 우선순위 뱃지 스타일 -->
.priority-badge {
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.priority-high {
  background: #FEE2E2;
  color: #DC2626;
}

.priority-medium {
  background: #FEF3C7;
  color: #D97706;
}

.priority-low {
  background: #DCFCE7;
  color: #16A34A;
}
      ]]>
    </priority-badge-design>

    <duplicate-warning-design>
      <![CDATA[
<!-- 중복 경고 배너 스타일 -->
.duplicate-warning {
  background: #FEF3C7;
  border: 1px solid #FDE68A;
  border-radius: 8px;
  padding: 12px 16px;
  color: #92400E;
}

.duplicate-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  background: white;
  border-radius: 4px;
  margin-top: 8px;
}

.similarity-badge {
  background: #F59E0B;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
}
      ]]>
    </duplicate-warning-design>

    <rate-limit-ui>
      <![CDATA[
<!-- Rate Limit 초과 시 Toast -->
+--------------------------------------------------+
| ⚠️ AI Rate Limit Reached                    [×]  |
|                                                  |
| You've reached the AI usage limit.               |
| Try again in 45 seconds.                         |
|                                                  |
| Remaining today: 0/100                           |
+--------------------------------------------------+

<!-- AI 버튼 비활성화 스타일 -->
.ai-btn-disabled {
  background: #E4E4E7;
  color: #A1A1AA;
  cursor: not-allowed;
  opacity: 0.6;
}
      ]]>
    </rate-limit-ui>
  </ux-design-reference>

  <existing-codebase>
    <relevant-files>
      <file path="jira-lite-mvp/components/ui/ai-button.tsx">
        <description>AI 버튼 컴포넌트</description>
      </file>
      <file path="jira-lite-mvp/components/ui/priority-badge.tsx">
        <description>우선순위 뱃지 컴포넌트</description>
      </file>
      <file path="jira-lite-mvp/components/ui/label-tag.tsx">
        <description>라벨 태그 컴포넌트</description>
      </file>
      <file path="jira-lite-mvp/lib/supabase/types.ts">
        <description>DB 타입 정의 (ai_rate_limits, labels 테이블 포함)</description>
      </file>
    </relevant-files>

    <existing-types>
      <![CDATA[
// lib/supabase/types.ts에서 발췌
export type Label = Tables<'labels'>
// {
//   id: string
//   project_id: string
//   name: string
//   color: string
// }

export type AiRateLimit = Tables<'ai_rate_limits'>
// {
//   user_id: string
//   minute_count: number
//   minute_reset_at: string | null
//   daily_count: number
//   daily_reset_at: string | null
// }

export type IssuePriority = 'HIGH' | 'MEDIUM' | 'LOW'
      ]]>
    </existing-types>
  </existing-codebase>

  <dependencies>
    <npm-packages>
      <package name="openai" version="^6.9.1">OpenAI API 클라이언트</package>
      <package name="use-debounce" version="latest">Debounce 훅 (중복 체크용)</package>
    </npm-packages>

    <environment-variables>
      <variable name="OPENAI_API_KEY" required="true">OpenAI API 키</variable>
    </environment-variables>
  </dependencies>

  <testing-guidance>
    <unit-tests>
      <test>라벨 제안이 프로젝트 라벨 목록에서만 선택됨</test>
      <test>우선순위 제안이 LOW/MEDIUM/HIGH 중 하나</test>
      <test>Rate Limiter 분당 10회 제한 동작</test>
      <test>Rate Limiter 일당 100회 제한 동작</test>
      <test>중복 탐지가 유사도 0.8 이상만 반환</test>
    </unit-tests>

    <integration-tests>
      <test>POST /api/ai/suggest - 라벨 제안 정상 반환</test>
      <test>POST /api/ai/suggest - 우선순위 제안 정상 반환</test>
      <test>POST /api/ai/duplicate - 중복 이슈 감지</test>
      <test>GET /api/ai/rate-limit - 사용량 상태 조회</test>
      <test>Rate Limit 초과 시 429 응답</test>
    </integration-tests>

    <e2e-scenarios>
      <scenario>이슈 생성 폼 → AI 라벨 추천 → 라벨 선택 → 적용</scenario>
      <scenario>이슈 생성 폼 → AI 우선순위 추천 → 적용</scenario>
      <scenario>이슈 제목 입력 → 중복 경고 표시 → 무시하고 생성</scenario>
      <scenario>Rate Limit 초과 → 에러 메시지 → 시간 후 재시도</scenario>
    </e2e-scenarios>
  </testing-guidance>

  <notes>
    <note priority="high">중복 탐지는 debounce 500ms 적용하여 API 호출 최소화</note>
    <note priority="high">Rate Limit 상태는 실시간으로 UI에 반영</note>
    <note priority="medium">라벨 제안 시 기존 선택된 라벨 제외</note>
    <note priority="medium">우선순위 제안 이유(reason) 표시로 신뢰성 제공</note>
  </notes>
</story-context>
