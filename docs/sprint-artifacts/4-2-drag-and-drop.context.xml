<story-context id="4-2-drag-and-drop" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>2</storyId>
    <title>Drag &amp; Drop 기능</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-2-drag-and-drop.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>프로젝트 팀 멤버</asA>
    <iWant>이슈 카드를 드래그하여 다른 컬럼으로 이동하거나 같은 컬럼 내에서 순서를 변경</iWant>
    <soThat>직관적인 시각적 인터랙션으로 이슈 상태를 빠르게 변경하고 작업 우선순위를 조정할 수 있다</soThat>
    <tasks>
      <part id="A" name="@dnd-kit 라이브러리 설정">
        <task id="1" ac="1,3,7">@dnd-kit 패키지 설치 및 설정
          <subtask id="1.1">npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities 실행</subtask>
          <subtask id="1.2">package.json 의존성 확인 (@dnd-kit/core ^6.x, @dnd-kit/sortable ^8.x)</subtask>
          <subtask id="1.3">타입 정의 파일 확인 (TypeScript 지원)</subtask>
        </task>
      </part>
      <part id="B" name="KanbanBoard DnD 컨텍스트 래핑">
        <task id="2" ac="1,6,12">DndContext Provider 통합
          <subtask id="2.1">components/kanban/board.tsx 수정 - DndContext로 래핑</subtask>
          <subtask id="2.2">sensors 설정: PointerSensor, KeyboardSensor</subtask>
          <subtask id="2.3">collisionDetection 설정: closestCorners 알고리즘</subtask>
          <subtask id="2.4">드래그 이벤트 핸들러 구현: onDragStart, onDragOver, onDragEnd</subtask>
        </task>
      </part>
      <part id="C" name="SortableContext 및 컬럼 설정">
        <task id="3" ac="7,8">KanbanColumn에 SortableContext 적용
          <subtask id="3.1">components/kanban/column.tsx 수정 - SortableContext로 카드 목록 래핑</subtask>
          <subtask id="3.2">strategy 설정: verticalListSortingStrategy</subtask>
          <subtask id="3.3">items prop으로 이슈 ID 배열 전달</subtask>
          <subtask id="3.4">드롭 존 하이라이트 스타일 추가</subtask>
        </task>
      </part>
      <part id="D" name="드래그 가능한 이슈 카드">
        <task id="4" ac="1,3,4,7,10">SortableIssue 래퍼 컴포넌트 구현
          <subtask id="4.1">components/kanban/sortable-issue.tsx 생성</subtask>
          <subtask id="4.2">useSortable 훅 적용: attributes, listeners, setNodeRef, transform, transition</subtask>
          <subtask id="4.3">드래그 중 스타일 적용: rotate(3deg), shadow-lg, opacity-0.9</subtask>
          <subtask id="4.4">isDragging 상태에 따른 placeholder 렌더링</subtask>
        </task>
        <task id="5" ac="10">터치 디바이스 최적화
          <subtask id="5.1">PointerSensor activationConstraint 설정: delay: 150, tolerance: 5</subtask>
          <subtask id="5.2">터치 타겟 최소 크기 보장: 44x44px</subtask>
          <subtask id="5.3">touch-action: none CSS 적용</subtask>
        </task>
      </part>
      <part id="E" name="드래그 오버레이">
        <task id="6" ac="3,4">DragOverlay 컴포넌트 구현
          <subtask id="6.1">components/kanban/drag-overlay.tsx 생성</subtask>
          <subtask id="6.2">DndContext 내 DragOverlay 추가</subtask>
          <subtask id="6.3">현재 드래그 중인 아이템 렌더링 (activeId 기반)</subtask>
          <subtask id="6.4">오버레이 스타일: rotate-3, shadow-lg, scale-105</subtask>
        </task>
      </part>
      <part id="F" name="이슈 이동 API">
        <task id="7" ac="2,8,11">PUT /api/issues/[issueId]/move 엔드포인트 구현
          <subtask id="7.1">app/api/issues/[issueId]/move/route.ts 생성</subtask>
          <subtask id="7.2">Request Body 검증: status_id, position</subtask>
          <subtask id="7.3">팀 멤버십 검증 (RLS 활용)</subtask>
          <subtask id="7.4">트랜잭션으로 이슈 업데이트</subtask>
          <subtask id="7.5">issue_history 기록 (상태 변경 시)</subtask>
          <subtask id="7.6">응답 형식: success, data.issue, data.affected_issues</subtask>
        </task>
      </part>
      <part id="G" name="Optimistic Updates 구현">
        <task id="8" ac="6,12">TanStack Query 낙관적 업데이트 설정
          <subtask id="8.1">hooks/use-kanban.ts 수정 - useMutation 추가</subtask>
          <subtask id="8.2">onMutate 콜백: 이전 상태 스냅샷, 캐시 즉시 업데이트</subtask>
          <subtask id="8.3">onError 콜백: 스냅샷으로 롤백, Toast 에러</subtask>
          <subtask id="8.4">onSettled 콜백: 쿼리 무효화</subtask>
        </task>
      </part>
      <part id="H" name="드래그 이벤트 핸들러">
        <task id="9" ac="1,2,7,8">onDragEnd 로직 구현
          <subtask id="9.1">이동 방향 판단: 컬럼 간 이동 vs 컬럼 내 순서 변경</subtask>
          <subtask id="9.2">새 position 계산: Fractional Indexing 또는 정수 재배열</subtask>
          <subtask id="9.3">moveMutation.mutate() 호출</subtask>
          <subtask id="9.4">드래그 상태 초기화</subtask>
        </task>
        <task id="10" ac="5">onDragOver 로직 구현
          <subtask id="10.1">현재 호버 중인 컬럼 ID 추적</subtask>
          <subtask id="10.2">호버 컬럼 하이라이트 상태 업데이트</subtask>
        </task>
      </part>
      <part id="I" name="타입 정의 확장">
        <task id="11" ac="전체">칸반 관련 타입 확장
          <subtask id="11.1">types/kanban.ts 수정: DragState 인터페이스</subtask>
          <subtask id="11.2">MoveIssueRequest, MoveIssueResponse 타입 추가</subtask>
        </task>
      </part>
      <part id="J" name="테스트">
        <task id="12" ac="1-12">E2E 테스트 시나리오
          <subtask id="12.1">컬럼 간 드래그 앤 드롭 테스트</subtask>
          <subtask id="12.2">같은 컬럼 내 순서 변경 테스트</subtask>
          <subtask id="12.3">새로고침 후 순서 유지 테스트</subtask>
          <subtask id="12.4">API 실패 시 롤백 테스트</subtask>
          <subtask id="12.5">모바일 터치 드래그 테스트</subtask>
        </task>
      </part>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" fr="FR-051" verify="카드 드래그 → 다른 컬럼 드롭 → 이동 확인">이슈 카드를 드래그하여 다른 컬럼에 드롭할 수 있다</criterion>
    <criterion id="AC-2" fr="FR-051" verify="API 호출 후 issues.status_id 변경 확인">드롭 시 이슈 상태가 해당 컬럼의 상태로 자동 변경된다</criterion>
    <criterion id="AC-3" fr="FR-051" verify="드래그 중 카드 스타일 변경 확인">드래그 시작 시 시각적 피드백(회전 3°, 그림자 증가)이 표시된다</criterion>
    <criterion id="AC-4" fr="FR-051" verify="드래그 시 빈 공간 placeholder 렌더링 확인">드래그 중 원본 위치에 placeholder가 표시된다</criterion>
    <criterion id="AC-5" fr="FR-051" verify="드래그 오버 시 컬럼 테두리 색상 변경 확인">드롭 존(다른 컬럼) 진입 시 하이라이트가 표시된다</criterion>
    <criterion id="AC-6" fr="FR-051" verify="React DevTools Profiler로 업데이트 시간 측정">드롭 후 100ms 이내에 UI가 업데이트된다 (Optimistic Update)</criterion>
    <criterion id="AC-7" fr="FR-052" verify="컬럼 내 카드 재정렬 후 순서 확인">같은 컬럼 내에서 이슈 카드 순서를 드래그로 변경할 수 있다</criterion>
    <criterion id="AC-8" fr="FR-052" verify="순서 변경 → 새로고침 → 동일 순서 확인">변경된 순서가 저장되어 새로고침 후에도 유지된다</criterion>
    <criterion id="AC-9" fr="FR-052" verify="이슈 생성 후 position 값 확인">새 이슈는 컬럼 최하단에 추가된다</criterion>
    <criterion id="AC-10" fr="FR-051" verify="터치 디바이스에서 150ms 홀드 후 드래그 동작 확인">모바일/터치 디바이스에서 길게 누르기로 드래그를 시작할 수 있다</criterion>
    <criterion id="AC-11" fr="FR-051" verify="드롭 후 issue_history 테이블 INSERT 확인">상태 변경 시 issue_history에 변경 기록이 저장된다</criterion>
    <criterion id="AC-12" fr="FR-051" verify="네트워크 오류 시뮬레이션 → 카드 원위치 복원 확인">API 호출 실패 시 UI가 원래 상태로 롤백된다</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Jira Lite MVP - Product Requirements Document</title>
        <section>FR-051: Drag &amp; Drop 이동</section>
        <snippet>이슈 카드를 다른 컬럼으로 드래그하여 상태를 변경할 수 있어야 한다. Drag &amp; Drop 반응: 즉각적 (100ms 이내)</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Jira Lite MVP - Product Requirements Document</title>
        <section>FR-052: 같은 컬럼 내 순서 변경</section>
        <snippet>같은 상태(컬럼) 내에서 이슈 순서를 위아래로 드래그하여 변경할 수 있어야 한다. 순서 정보 저장 (position/order 필드), 새 이슈는 컬럼 최하단에 추가</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Jira Lite MVP - Architecture Document</title>
        <section>Drag &amp; Drop</section>
        <snippet>@dnd-kit 선택 - 현대적, 접근성 우수, React 18 완전 호환, UX 스펙 권장. issues 테이블에 position 필드 포함</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Jira Lite MVP - Architecture Document</title>
        <section>Project Structure</section>
        <snippet>components/kanban/ 폴더에 board.tsx, column.tsx, issue-card.tsx, sortable-issue.tsx 컴포넌트 배치</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>Jira Lite MVP UX Design Specification</title>
        <section>2.2 영감 분석 및 UX 패턴 - Drag &amp; Drop</section>
        <snippet>물리적 느낌을 디지털로 (100ms 이내 반응, 마지막 드롭 존 기억). 드래그 중 시각적 피드백 (회전, 그림자)</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>Jira Lite MVP UX Design Specification</title>
        <section>7.1 Consistency Rules - Feedback Patterns</section>
        <snippet>드래그 중 카드 스타일: rotate-3 shadow-lg opacity-90 scale-105 z-50, Placeholder: border-2 border-dashed border-zinc-300 opacity-50</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Jira Lite MVP - Epic Breakdown</title>
        <section>Story 4.2: Drag &amp; Drop</section>
        <snippet>@dnd-kit 기반 드래그 앤 드롭 구현. 컬럼 간 이동 시 상태 자동 변경. Optimistic Updates를 통한 즉각적 UI 반영</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic Technical Specification: 칸반 보드 &amp; 댓글</title>
        <section>Detailed Design - Workflows and Sequencing</section>
        <snippet>Drag &amp; Drop 시퀀스: DndContext onDragEnd → TanStack Query 낙관적 업데이트 → API PUT /move → 성공시 UI 유지 / 실패시 롤백</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic Technical Specification: 칸반 보드 &amp; 댓글</title>
        <section>APIs and Interfaces - 이슈 이동 API</section>
        <snippet>PUT /api/issues/[issueId]/move - Request: { status_id, position }, Response: { success, data: { issue, affected_issues } }</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/4-1-kanban-board-basic-ui.md</path>
        <title>Story 4.1: 칸반 보드 기본 UI</title>
        <section>선행 스토리</section>
        <snippet>KanbanBoard, KanbanColumn, IssueCard 컴포넌트가 Story 4.1에서 구현됨. Story 4.2에서 DnD 기능 추가</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>jira-lite-mvp/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>10-12</lines>
        <reason>@dnd-kit 패키지가 이미 설치됨: @dnd-kit/core ^6.3.1, @dnd-kit/sortable ^10.0.0, @dnd-kit/utilities ^3.2.2</reason>
      </file>
      <file>
        <path>jira-lite-mvp/tailwind.config.ts</path>
        <kind>config</kind>
        <symbol>colors.column, colors.priority</symbol>
        <lines>74-99</lines>
        <reason>칸반 컬럼 색상(backlog, progress, review, done)과 우선순위 색상이 이미 정의됨</reason>
      </file>
      <file>
        <path>jira-lite-mvp/components/ui/badge.tsx</path>
        <kind>component</kind>
        <symbol>Badge, badgeVariants</symbol>
        <lines>1-37</lines>
        <reason>우선순위 배지 등에 재사용할 수 있는 Badge 컴포넌트</reason>
      </file>
      <file>
        <path>jira-lite-mvp/app/(dashboard)/layout.tsx</path>
        <kind>layout</kind>
        <symbol>DashboardLayout</symbol>
        <lines>1-10</lines>
        <reason>AppShell 레이아웃 사용 - 칸반 보드가 이 레이아웃 내에 렌더링됨</reason>
      </file>
      <file>
        <path>jira-lite-mvp/components/layout/app-shell.tsx</path>
        <kind>component</kind>
        <symbol>AppShell</symbol>
        <reason>Sidebar + Header + Main 영역 레이아웃 컴포넌트</reason>
      </file>
      <file>
        <path>jira-lite-mvp/hooks/use-auth.ts</path>
        <kind>hook</kind>
        <symbol>useAuth</symbol>
        <lines>1-6</lines>
        <reason>인증 훅 - API 호출 시 사용자 인증 상태 확인에 활용</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <package>@dnd-kit/core</package>
        <version>^6.3.1</version>
        <usage>DndContext, useDraggable, useDroppable, DragOverlay, sensors, collision detection</usage>
      </node>
      <node>
        <package>@dnd-kit/sortable</package>
        <version>^10.0.0</version>
        <usage>SortableContext, useSortable, verticalListSortingStrategy, arrayMove</usage>
      </node>
      <node>
        <package>@dnd-kit/utilities</package>
        <version>^3.2.2</version>
        <usage>CSS.Transform.toString for transform styles</usage>
      </node>
      <node>
        <package>@tanstack/react-query</package>
        <version>^5.90.11</version>
        <usage>useMutation, useQueryClient for optimistic updates</usage>
      </node>
      <node>
        <package>zustand</package>
        <version>^5.0.8</version>
        <usage>UI state management for drag state (activeId, overColumn)</usage>
      </node>
      <node>
        <package>sonner</package>
        <version>^2.0.7</version>
        <usage>Toast notifications for error/success feedback</usage>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance">드롭 후 100ms 이내에 UI가 업데이트되어야 함 (Optimistic Update 필수)</constraint>
    <constraint type="performance">드래그 시작 반응 50ms 이내</constraint>
    <constraint type="performance">API 응답 시간 300ms 이내</constraint>
    <constraint type="accessibility">터치 타겟 최소 44x44px 보장</constraint>
    <constraint type="accessibility">키보드 네비게이션 지원 (KeyboardSensor)</constraint>
    <constraint type="ux">드래그 중 카드 스타일: rotate-3, shadow-lg, opacity-90</constraint>
    <constraint type="ux">placeholder: border-2 border-dashed border-zinc-300 opacity-50 bg-zinc-100</constraint>
    <constraint type="ux">드롭 존 활성화: border-2 border-primary border-dashed bg-primary/5</constraint>
    <constraint type="api">API 응답 형식: { success: true, data: {...} } 또는 { success: false, error: {...} }</constraint>
    <constraint type="database">issue_history 테이블에 상태 변경 기록 필수 (field_name: 'status')</constraint>
    <constraint type="pattern">Fractional Indexing 권장: position = (prev + next) / 2</constraint>
    <constraint type="security">팀 멤버십 검증 필수 (FR-070) - RLS 정책 활용</constraint>
    <constraint type="mobile">터치 드래그: 150ms 홀드 후 시작, tolerance: 5px</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>MoveIssueRequest</name>
      <kind>TypeScript interface</kind>
      <signature>interface MoveIssueRequest { status_id: string; position: number; }</signature>
      <path>types/kanban.ts (생성 예정)</path>
    </interface>
    <interface>
      <name>MoveIssueResponse</name>
      <kind>TypeScript interface</kind>
      <signature>interface MoveIssueResponse { success: true; data: { issue: Issue; affected_issues: { id: string; position: number }[]; }; }</signature>
      <path>types/kanban.ts (생성 예정)</path>
    </interface>
    <interface>
      <name>DragState</name>
      <kind>TypeScript interface</kind>
      <signature>interface DragState { activeId: string | null; activeColumn: string | null; overColumn: string | null; }</signature>
      <path>types/kanban.ts (생성 예정)</path>
    </interface>
    <interface>
      <name>PUT /api/issues/[issueId]/move</name>
      <kind>REST endpoint</kind>
      <signature>PUT /api/issues/:issueId/move - Body: MoveIssueRequest - Response: MoveIssueResponse</signature>
      <path>app/api/issues/[issueId]/move/route.ts (생성 예정)</path>
    </interface>
    <interface>
      <name>useSortable hook</name>
      <kind>@dnd-kit hook</kind>
      <signature>const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id })</signature>
      <path>@dnd-kit/sortable</path>
    </interface>
    <interface>
      <name>DndContext</name>
      <kind>@dnd-kit component</kind>
      <signature>&lt;DndContext sensors={sensors} collisionDetection={closestCorners} onDragStart onDragOver onDragEnd&gt;</signature>
      <path>@dnd-kit/core</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest + React Testing Library for unit/integration tests.
      Chrome DevTools MCP for E2E testing.
      테스트 파일은 __tests__ 폴더 또는 *.test.ts(x) 패턴 사용.
      Optimistic Update 롤백 테스트를 위해 MSW 또는 네트워크 오류 시뮬레이션 활용.
    </standards>
    <locations>
      <location>jira-lite-mvp/__tests__/</location>
      <location>jira-lite-mvp/components/**/*.test.tsx</location>
      <location>jira-lite-mvp/app/api/**/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-1,AC-2">컬럼 간 드래그 앤 드롭 테스트: 카드를 In Progress에서 Done으로 이동 → status_id 변경 확인</idea>
      <idea ac="AC-3,AC-4">드래그 시각적 피드백 테스트: 드래그 시작 시 카드에 rotate-3, shadow-lg 클래스 적용 확인</idea>
      <idea ac="AC-5">드롭 존 하이라이트 테스트: 드래그 오버 시 컬럼에 border-primary 클래스 적용 확인</idea>
      <idea ac="AC-6">Optimistic Update 성능 테스트: 드롭 후 UI 업데이트 시간 측정 (100ms 이내)</idea>
      <idea ac="AC-7,AC-8">같은 컬럼 내 순서 변경 테스트: 카드 순서 변경 후 새로고침 → 동일 순서 유지 확인</idea>
      <idea ac="AC-9">새 이슈 position 테스트: 이슈 생성 후 해당 컬럼 최하단 position 값 확인</idea>
      <idea ac="AC-10">터치 드래그 테스트: 150ms 홀드 후 드래그 시작, 짧은 탭은 드래그 안됨 확인</idea>
      <idea ac="AC-11">issue_history 기록 테스트: 상태 변경 후 issue_history INSERT 확인</idea>
      <idea ac="AC-12">롤백 테스트: API 500 에러 시뮬레이션 → 카드 원위치 복원 + Toast 에러 표시 확인</idea>
    </ideas>
  </tests>
</story-context>
