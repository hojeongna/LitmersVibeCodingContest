<story-context id="3-2-project-advanced-features" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>프로젝트 고급 기능 (마크다운, 아카이브, 즐겨찾기)</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-2-project-advanced-features.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>팀 멤버</asA>
    <iWant>프로젝트 설명에 마크다운을 사용하고, 프로젝트를 아카이브/즐겨찾기로 관리</iWant>
    <soThat>프로젝트 정보를 풍부하게 표현하고, 활성/비활성 프로젝트를 효율적으로 정리</soThat>
    <tasks>
      <taskGroup id="1" name="마크다운 지원" ac="#1, #2, #3">
        <task id="1.1">마크다운 관련 패키지 설치 (react-markdown, rehype-sanitize, remark-gfm)</task>
        <task id="1.2">components/shared/markdown-renderer.tsx 컴포넌트 구현 (XSS 방지, prose 스타일)</task>
        <task id="1.3">프로젝트 상세 페이지에 MarkdownRenderer 적용</task>
      </taskGroup>
      <taskGroup id="2" name="아카이브 기능" ac="#4, #5, #6, #7">
        <task id="2.1">PUT /api/projects/[projectId]/archive 엔드포인트 생성 (권한 검증 포함)</task>
        <task id="2.2">GET /api/projects에 archived 쿼리 파라미터 지원</task>
        <task id="2.3">Sidebar 프로젝트 목록에서 아카이브 필터링</task>
        <task id="2.4">아카이브/복원 UI 버튼 및 확인 모달</task>
      </taskGroup>
      <taskGroup id="3" name="즐겨찾기 기능" ac="#8, #9, #10">
        <task id="3.1">PUT /api/projects/[projectId]/favorite 엔드포인트 생성</task>
        <task id="3.2">프로젝트 목록 API에 즐겨찾기 정렬 적용</task>
        <task id="3.3">Sidebar 즐겨찾기 UI (별 아이콘, 낙관적 업데이트)</task>
        <task id="3.4">프로젝트 상세 페이지 즐겨찾기 버튼</task>
      </taskGroup>
      <taskGroup id="4" name="TanStack Query 훅" ac="All">
        <task id="4.1">useProjects 훅에 archived 필터 추가, useArchiveProject/useFavoriteProject mutation 훅 생성</task>
      </taskGroup>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" fr="FR-025">프로젝트 설명 입력 시 마크다운 문법(헤더, 볼드, 이탤릭, 리스트, 코드블록)을 사용할 수 있어야 한다</criterion>
    <criterion id="AC-2" fr="FR-025">프로젝트 상세 페이지에서 마크다운이 렌더링되어 표시되어야 한다</criterion>
    <criterion id="AC-3" fr="FR-025">마크다운 렌더링 시 XSS 공격을 방지하기 위해 HTML이 정제되어야 한다</criterion>
    <criterion id="AC-4" fr="FR-026">팀 OWNER, ADMIN, 프로젝트 소유자는 프로젝트를 아카이브할 수 있어야 한다</criterion>
    <criterion id="AC-5" fr="FR-026">아카이브된 프로젝트는 기본 프로젝트 목록/Sidebar에서 숨겨져야 한다</criterion>
    <criterion id="AC-6" fr="FR-026">아카이브된 프로젝트를 별도 필터/탭에서 조회할 수 있어야 한다</criterion>
    <criterion id="AC-7" fr="FR-026">아카이브된 프로젝트를 복원(unarchive)할 수 있어야 한다</criterion>
    <criterion id="AC-8" fr="FR-027">사용자는 프로젝트를 즐겨찾기에 추가/제거할 수 있어야 한다</criterion>
    <criterion id="AC-9" fr="FR-027">즐겨찾기 토글 시 Sidebar 프로젝트 목록에 즉시 반영되어야 한다</criterion>
    <criterion id="AC-10" fr="FR-027">즐겨찾기 프로젝트는 목록 상단에 우선 표시되어야 한다</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="3. Visual Foundation - Color System" snippet="즐겨찾기 아이콘: 비활성 #71717A outline star, 활성 #F59E0B filled star. 아카이브: opacity 0.6, 회색 배지" />
      <doc path="docs/ux-design-directions.html" title="Design Mockups" section="Sidebar, Kanban" snippet="프로젝트 목록 UI, sidebar-item 스타일, project-dot 컬러 코딩" />
      <doc path="docs/ux-color-themes.html" title="Color Theme Visualizer" section="Semantic Colors" snippet="Warning: #F59E0B (즐겨찾기), Success: #22C55E, Error: #EF4444" />
      <doc path="docs/sprint-artifacts/tech-spec-epic-3.md" title="Epic 3 Tech Spec" section="Data Models, APIs" snippet="projects.is_archived 필드, project_favorites 테이블, 아카이브/즐겨찾기 API 정의" />
      <doc path="CLAUDE.md" title="프로젝트 개발 가이드" section="API Response Format" snippet="성공: {success: true, data: {...}}, 에러: {success: false, error: {code, message}}" />
    </docs>
    <code>
      <file path="jira-lite-mvp/components/layout/sidebar.tsx" kind="component" symbol="Sidebar" lines="all" reason="프로젝트 목록 렌더링, 즐겨찾기/아카이브 필터링 UI 확장 필요" />
      <file path="jira-lite-mvp/components/ui/button.tsx" kind="component" symbol="Button" reason="아카이브/즐겨찾기 버튼에 사용" />
      <file path="jira-lite-mvp/components/ui/badge.tsx" kind="component" symbol="Badge" reason="아카이브 상태 배지 표시" />
      <file path="jira-lite-mvp/components/ui/dialog.tsx" kind="component" symbol="Dialog" reason="아카이브 확인 모달" />
      <file path="jira-lite-mvp/components/ui/tooltip.tsx" kind="component" symbol="Tooltip" reason="즐겨찾기 버튼 툴팁" />
      <file path="jira-lite-mvp/lib/utils.ts" kind="utility" symbol="cn" reason="className 병합 유틸리티" />
      <file path="jira-lite-mvp/tailwind.config.ts" kind="config" symbol="theme.extend.colors" reason="priority, label, sidebar 색상 정의 확인" />
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="react-markdown" version="^9.x" purpose="마크다운 렌더링" />
        <package name="rehype-sanitize" version="^6.x" purpose="XSS 방지 HTML 정제" />
        <package name="remark-gfm" version="^4.x" purpose="GitHub Flavored Markdown 지원" />
        <package name="@tanstack/react-query" version="^5.90.11" installed="true" purpose="서버 상태 관리, 캐싱, 낙관적 업데이트" />
        <package name="@supabase/supabase-js" version="latest" installed="true" purpose="Supabase 클라이언트" />
        <package name="zod" version="^4.1.13" installed="true" purpose="유효성 검증 스키마" />
        <package name="lucide-react" version="^0.511.0" installed="true" purpose="Star, Archive 아이콘" />
        <package name="sonner" version="^2.0.7" installed="true" purpose="Toast 알림" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="tech-spec-epic-3.md" type="authorization">삭제/아카이브: 이슈 소유자, 프로젝트 소유자, 팀 OWNER/ADMIN만 가능</constraint>
    <constraint source="tech-spec-epic-3.md" type="security">RLS 정책: 모든 프로젝트 접근은 팀 멤버십 기반</constraint>
    <constraint source="tech-spec-epic-3.md" type="security">마크다운 렌더링 시 XSS 방지: 허용 태그만 사용 (h1-h4, p, ul, ol, li, code, pre, blockquote, a, strong, em)</constraint>
    <constraint source="CLAUDE.md" type="api">API Response Format: {success, data} 또는 {success: false, error: {code, message}}</constraint>
    <constraint source="tech-spec-epic-3.md" type="data">프로젝트 설명: 최대 2000자, 마크다운 지원</constraint>
    <constraint source="tech-spec-epic-3.md" type="pattern">Soft Delete: deleted_at 필드 사용</constraint>
    <constraint source="tech-spec-epic-3.md" type="state">TanStack Query: 낙관적 업데이트 + 캐시 무효화</constraint>
  </constraints>

  <interfaces>
    <interface name="PUT /api/projects/[projectId]/archive" kind="REST endpoint">
      <signature>PUT /api/projects/:projectId/archive → {success: true, data: {isArchived: boolean}}</signature>
      <path>jira-lite-mvp/app/api/projects/[projectId]/archive/route.ts</path>
      <notes>토글 방식: 현재 is_archived 값 반전. 권한: OWNER, ADMIN, 프로젝트 소유자</notes>
    </interface>
    <interface name="PUT /api/projects/[projectId]/favorite" kind="REST endpoint">
      <signature>PUT /api/projects/:projectId/favorite → {success: true, data: {isFavorite: boolean}}</signature>
      <path>jira-lite-mvp/app/api/projects/[projectId]/favorite/route.ts</path>
      <notes>토글 방식: project_favorites 테이블 INSERT/DELETE</notes>
    </interface>
    <interface name="GET /api/projects" kind="REST endpoint">
      <signature>GET /api/projects?teamId=...&amp;archived=false → {success: true, data: Project[]}</signature>
      <path>jira-lite-mvp/app/api/projects/route.ts</path>
      <notes>archived 파라미터: true, false, all. 기본값 false. 즐겨찾기 정렬: isFavorite DESC, createdAt DESC</notes>
    </interface>
    <interface name="MarkdownRenderer" kind="React component">
      <signature>MarkdownRenderer: FC&lt;{content: string, className?: string}&gt;</signature>
      <path>jira-lite-mvp/components/shared/markdown-renderer.tsx</path>
      <notes>react-markdown + rehype-sanitize + remark-gfm 사용. prose 스타일 적용</notes>
    </interface>
    <interface name="useArchiveProject" kind="React hook">
      <signature>useArchiveProject(): UseMutationResult&lt;{isArchived: boolean}, Error, string&gt;</signature>
      <path>jira-lite-mvp/hooks/use-projects.ts</path>
      <notes>낙관적 업데이트 + onSettled에서 projects 쿼리 무효화</notes>
    </interface>
    <interface name="useFavoriteProject" kind="React hook">
      <signature>useFavoriteProject(): UseMutationResult&lt;{isFavorite: boolean}, Error, string&gt;</signature>
      <path>jira-lite-mvp/hooks/use-projects.ts</path>
      <notes>낙관적 업데이트 + onSettled에서 projects 쿼리 무효화</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      E2E 테스트: Chrome DevTools MCP 사용. API 통합 테스트: 수동 검증 또는 Supabase 테스트 DB.
      마크다운 XSS 테스트: 스크립트 태그 입력 후 렌더링 결과 확인.
    </standards>
    <locations>
      <location>jira-lite-mvp/app/api/**/route.ts</location>
      <location>jira-lite-mvp/components/shared/markdown-renderer.tsx</location>
      <location>jira-lite-mvp/hooks/use-projects.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-1">마크다운 문법(# 헤더, **볼드**, *이탤릭*, - 리스트, `코드`) 입력 후 저장 확인</idea>
      <idea ac="AC-2">프로젝트 상세 페이지에서 마크다운 렌더링 결과 시각적 확인</idea>
      <idea ac="AC-3">XSS 테스트: &lt;script&gt;alert('xss')&lt;/script&gt; 입력 후 실행되지 않음 확인</idea>
      <idea ac="AC-4">OWNER, ADMIN, 프로젝트 소유자로 아카이브 성공 / MEMBER로 403 에러</idea>
      <idea ac="AC-5">아카이브 후 Sidebar 프로젝트 목록에서 사라짐 확인</idea>
      <idea ac="AC-6">"Show archived" 토글 또는 archived=true 쿼리로 아카이브 프로젝트 조회</idea>
      <idea ac="AC-7">아카이브된 프로젝트 복원 후 기본 목록에 다시 표시</idea>
      <idea ac="AC-8">즐겨찾기 버튼 클릭 → API 호출 → 상태 변경 확인</idea>
      <idea ac="AC-9">즐겨찾기 토글 시 Sidebar 즉시 업데이트 (낙관적 업데이트)</idea>
      <idea ac="AC-10">즐겨찾기 프로젝트가 목록 최상단에 표시됨 확인</idea>
    </ideas>
  </tests>

  <uxReference>
    <colors>
      <color name="Primary" hex="#5B5FC7" usage="주요 버튼, 포커스 상태" />
      <color name="Accent/Info" hex="#3B82F6" usage="AI 기능, 강조 요소" />
      <color name="Warning" hex="#F59E0B" usage="즐겨찾기 활성 별 아이콘" />
      <color name="Text Secondary" hex="#71717A" usage="즐겨찾기 비활성 별 아이콘, 보조 텍스트" />
      <color name="Background" hex="#FAFAFA" usage="페이지 배경" />
      <color name="Surface" hex="#FFFFFF" usage="카드, 모달 배경" />
      <color name="Border" hex="#E4E4E7" usage="구분선, 테두리" />
      <color name="Sidebar BG" hex="#18181B" usage="사이드바 배경" />
    </colors>
    <components>
      <component name="FavoriteButton" description="별 아이콘 버튼. 비활성: outline star (#71717A), 활성: filled star (#F59E0B). 툴팁 표시" />
      <component name="ArchiveBadge" description="아카이브 프로젝트 표시: opacity 0.6, 📦 아이콘 또는 회색 배지" />
      <component name="ArchiveConfirmDialog" description="아카이브 확인 모달. 제목, 설명, Cancel/Archive 버튼" />
    </components>
    <layout>
      <screen name="Sidebar" description="프로젝트 목록에 즐겨찾기 별 아이콘 추가. 아카이브 프로젝트는 기본적으로 숨김. 'Show archived' 토글 제공" />
      <screen name="ProjectDetail" description="프로젝트 헤더에 즐겨찾기 버튼. 설정에 아카이브 버튼. 설명란에 마크다운 렌더링" />
    </layout>
  </uxReference>

  <dbSchema>
    <table name="projects">
      <column name="is_archived" type="BOOLEAN" default="FALSE" description="아카이브 여부" />
    </table>
    <table name="project_favorites" pk="(user_id, project_id)">
      <column name="user_id" type="UUID" fk="profiles.id" description="즐겨찾기한 사용자" />
      <column name="project_id" type="UUID" fk="projects.id" description="즐겨찾기된 프로젝트" />
      <column name="created_at" type="TIMESTAMPTZ" default="NOW()" />
    </table>
  </dbSchema>
</story-context>
