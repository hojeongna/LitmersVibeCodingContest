<story-context id="2-5-activity-log" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2-5</storyId>
    <title>í™œë™ ë¡œê·¸</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-activity-log.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>íŒ€ ë©¤ë²„</asA>
    <iWant>íŒ€ í™œë™ ë¡œê·¸ë¥¼ ì¡°íšŒ</iWant>
    <soThat>íŒ€ ë‚´ì—ì„œ ì¼ì–´ë‚œ ë³€ê²½ ì‚¬í•­ì„ ì¶”ì í•˜ê³  íˆ¬ëª…ì„±ì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤</soThat>
    <tasks>
      <taskGroup title="Part A: í™œë™ ë¡œê·¸ API">
        <task id="1" title="í™œë™ ë¡œê·¸ ì¡°íšŒ API" ac="6, 7, 11">
          <subtask>1.1 app/api/teams/[teamId]/activities/route.ts ìƒì„± (GET)</subtask>
          <subtask>1.2 í˜ì´ì§€ë„¤ì´ì…˜ íŒŒë¼ë¯¸í„° (page, limit)</subtask>
          <subtask>1.3 ìµœì‹ ìˆœ ì •ë ¬ (created_at DESC)</subtask>
          <subtask>1.4 actor í”„ë¡œí•„ ì •ë³´ JOIN</subtask>
          <subtask>1.5 íŒ€ ë©¤ë²„ì‹­ ê²€ì¦</subtask>
        </task>
      </taskGroup>
      <taskGroup title="Part B: í™œë™ ë¡œê·¸ ê¸°ë¡ ì„œë¹„ìŠ¤">
        <task id="2" title="ActivityLogService êµ¬í˜„" ac="1, 2, 3, 4, 5">
          <subtask>2.1 lib/services/activity.ts ìƒì„±</subtask>
          <subtask>2.2 logActivity(teamId, actorId, action, targetType?, targetId?, details?) í•¨ìˆ˜</subtask>
          <subtask>2.3 ê¸°ì¡´ APIì— í™œë™ ë¡œê·¸ ê¸°ë¡ ì¶”ê°€</subtask>
        </task>
      </taskGroup>
      <taskGroup title="Part C: UI êµ¬í˜„">
        <task id="3" title="Activity Log íƒ­ í˜ì´ì§€" ac="6, 7, 8, 9, 10">
          <subtask>3.1 app/(dashboard)/teams/[teamId]/activity/page.tsx ìƒì„±</subtask>
          <subtask>3.2 ActivityTimeline ì»´í¬ë„ŒíŠ¸</subtask>
          <subtask>3.3 ë¬´í•œ ìŠ¤í¬ë¡¤ (Intersection Observer) ë˜ëŠ” Load More ë²„íŠ¼</subtask>
          <subtask>3.4 ë¹ˆ ìƒíƒœ UI</subtask>
        </task>
        <task id="4" title="í™œë™ ì•„ì´í…œ ì»´í¬ë„ŒíŠ¸" ac="8, 9, 10">
          <subtask>4.1 components/teams/activity-item.tsx ìƒì„±</subtask>
          <subtask>4.2 ì•„ì´ì½˜ + ì•¡ì…˜ í…ìŠ¤íŠ¸ + ìƒëŒ€ ì‹œê°„</subtask>
          <subtask>4.3 actor ì•„ë°”íƒ€ + ì´ë¦„</subtask>
          <subtask>4.4 í™œë™ íƒ€ì…ë³„ ìƒ‰ìƒ</subtask>
        </task>
      </taskGroup>
      <taskGroup title="Part D: í›… ë° ìœ í‹¸ë¦¬í‹°">
        <task id="5" title="í™œë™ ë¡œê·¸ í›…" ac="6, 7">
          <subtask>5.1 hooks/use-activities.ts ìƒì„±</subtask>
          <subtask>5.2 useTeamActivities(teamId) - ë¬´í•œ ì¿¼ë¦¬</subtask>
          <subtask>5.3 useInfiniteQuery í™œìš©</subtask>
        </task>
        <task id="6" title="ìƒëŒ€ ì‹œê°„ ìœ í‹¸ë¦¬í‹°" ac="10">
          <subtask>6.1 lib/utils/date.tsì— formatRelativeTime í•¨ìˆ˜ ì¶”ê°€</subtask>
          <subtask>6.2 date-fnsì˜ formatDistanceToNow í™œìš©</subtask>
          <subtask>6.3 í•œêµ­ì–´ ë¡œì¼€ì¼ ì ìš©</subtask>
        </task>
      </taskGroup>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" fr="FR-019">ë©¤ë²„ ê°€ì… ì´ë²¤íŠ¸ê°€ í™œë™ ë¡œê·¸ì— ê¸°ë¡ë¨</criterion>
    <criterion id="AC-2" fr="FR-019">ë©¤ë²„ íƒˆí‡´/í‡´ì¥ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë¨</criterion>
    <criterion id="AC-3" fr="FR-019">ì—­í•  ë³€ê²½ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë¨ (ë³€ê²½ ì „/í›„ ì—­í•  í¬í•¨)</criterion>
    <criterion id="AC-4" fr="FR-019">íŒ€ ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë¨</criterion>
    <criterion id="AC-5" fr="FR-019">ë©¤ë²„ ì´ˆëŒ€ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë¨</criterion>
    <criterion id="AC-6" fr="FR-019">í™œë™ ë¡œê·¸ëŠ” ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë¨</criterion>
    <criterion id="AC-7" fr="FR-019">ë¬´í•œ ìŠ¤í¬ë¡¤ ë˜ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„</criterion>
    <criterion id="AC-8" fr="FR-019">í™œë™ íƒ€ì…ë³„ ì•„ì´ì½˜/ìƒ‰ìƒ í‘œì‹œ</criterion>
    <criterion id="AC-9" fr="FR-019">í™œë™ ìˆ˜í–‰ì(actor) ì •ë³´ í‘œì‹œ</criterion>
    <criterion id="AC-10" fr="FR-019">ìƒëŒ€ ì‹œê°„ í‘œì‹œ (ì˜ˆ: "2ë¶„ ì „", "ì–´ì œ")</criterion>
    <criterion id="AC-11" fr="FR-019">API ì‘ë‹µ í˜•ì‹ì´ í‘œì¤€ í¬ë§· ì¤€ìˆ˜</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc type="tech-spec" priority="high">
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <relevance>í™œë™ ë¡œê·¸ ìŠ¤í™, team_activities í…Œì´ë¸”</relevance>
      </doc>
    </docs>

    <code>
      <existingComponents>
        <component path="jira-lite-mvp/components/ui/avatar.tsx" relevance="actor ì•„ë°”íƒ€"/>
        <component path="jira-lite-mvp/components/ui/skeleton.tsx" relevance="ë¡œë”© ìƒíƒœ"/>
        <component path="jira-lite-mvp/lib/supabase/server.ts" relevance="ì„œë²„ DB í´ë¼ì´ì–¸íŠ¸"/>
        <component path="jira-lite-mvp/lib/supabase/types.ts" relevance="TeamActivity íƒ€ì…"/>
      </existingComponents>

      <filesToCreate>
        <file path="jira-lite-mvp/app/api/teams/[teamId]/activities/route.ts" purpose="í™œë™ ë¡œê·¸ ì¡°íšŒ API"/>
        <file path="jira-lite-mvp/app/(dashboard)/teams/[teamId]/activity/page.tsx" purpose="Activity Log íƒ­"/>
        <file path="jira-lite-mvp/components/teams/activity-timeline.tsx" purpose="í™œë™ íƒ€ì„ë¼ì¸"/>
        <file path="jira-lite-mvp/components/teams/activity-item.tsx" purpose="í™œë™ ì•„ì´í…œ"/>
        <file path="jira-lite-mvp/lib/services/activity.ts" purpose="ActivityLogService"/>
        <file path="jira-lite-mvp/lib/utils/date.ts" purpose="ìƒëŒ€ ì‹œê°„ ìœ í‹¸"/>
        <file path="jira-lite-mvp/hooks/use-activities.ts" purpose="í™œë™ ë¡œê·¸ í›…"/>
      </filesToCreate>
    </code>

    <dependencies>
      <runtime>
        <package name="date-fns" version="^4.1.0" usage="ìƒëŒ€ ì‹œê°„ í¬ë§·"/>
        <package name="@tanstack/react-query" version="^5.90.11" usage="ë¬´í•œ ìŠ¤í¬ë¡¤ ì¿¼ë¦¬"/>
      </runtime>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">
      <title>íŒ€ ë©¤ë²„ì‹­ ê²€ì¦</title>
      <description>íŒ€ ë©¤ë²„ë§Œ í™œë™ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥</description>
    </constraint>
    <constraint type="performance">
      <title>í˜ì´ì§€ë„¤ì´ì…˜</title>
      <description>ëŒ€ëŸ‰ ë¡œê·¸ íš¨ìœ¨ì  ë¡œë“œë¥¼ ìœ„í•œ í˜ì´ì§€ë„¤ì´ì…˜/ë¬´í•œìŠ¤í¬ë¡¤ í•„ìˆ˜</description>
    </constraint>
  </constraints>

  <interfaces>
    <api endpoint="GET /api/teams/[teamId]/activities">
      <description>í™œë™ ë¡œê·¸ ì¡°íšŒ</description>
      <auth>íŒ€ ë©¤ë²„</auth>
      <queryParams>page, limit (ê¸°ë³¸ 20)</queryParams>
      <response>
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "team_id": "team-uuid",
      "actor_id": "user-uuid",
      "action": "member_joined",
      "target_type": "member",
      "target_id": "target-user-uuid",
      "details": { "role": "MEMBER" },
      "created_at": "2025-11-29T...",
      "actor": {
        "name": "ê¹€ì„œì—°",
        "avatar_url": null
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "totalPages": 3,
    "hasMore": true
  }
}
      </response>
    </api>

    <services>
      <service name="logActivity">
        <signature>logActivity(teamId, actorId, action, targetType?, targetId?, details?)</signature>
        <description>í™œë™ ë¡œê·¸ ê¸°ë¡ ì„œë¹„ìŠ¤ í•¨ìˆ˜</description>
        <actions>
          <action type="member_invited">ë©¤ë²„ ì´ˆëŒ€</action>
          <action type="member_joined">ë©¤ë²„ ê°€ì…</action>
          <action type="member_removed">ê°•ì œ í‡´ì¥</action>
          <action type="member_left">ìë°œì  íƒˆí‡´</action>
          <action type="role_changed">ì—­í•  ë³€ê²½</action>
          <action type="team_updated">íŒ€ ì„¤ì • ë³€ê²½</action>
          <action type="team_deleted">íŒ€ ì‚­ì œ</action>
        </actions>
      </service>
    </services>

    <hooks>
      <hook name="useTeamActivities(teamId)">í™œë™ ë¡œê·¸ ë¬´í•œ ì¿¼ë¦¬</hook>
    </hooks>

    <utils>
      <util name="formatRelativeTime(date)">ìƒëŒ€ ì‹œê°„ í¬ë§· (date-fns + ko ë¡œì¼€ì¼)</util>
    </utils>
  </interfaces>

  <tests>
    <ideas>
      <scenario id="1" ac="1, 2, 3, 4, 5" priority="high">
        <title>í™œë™ ë¡œê·¸ ê¸°ë¡ í™•ì¸</title>
        <steps>
          1. ë©¤ë²„ ì´ˆëŒ€ â†’ member_invited ë¡œê·¸ í™•ì¸
          2. ì´ˆëŒ€ ìˆ˜ë½ â†’ member_joined ë¡œê·¸ í™•ì¸
          3. ì—­í•  ë³€ê²½ â†’ role_changed ë¡œê·¸ (from/to í™•ì¸)
          4. ë©¤ë²„ í‡´ì¥ â†’ member_removed ë¡œê·¸ í™•ì¸
          5. íŒ€ ì„¤ì • ìˆ˜ì • â†’ team_updated ë¡œê·¸ í™•ì¸
        </steps>
      </scenario>
      <scenario id="2" ac="6, 7" priority="high">
        <title>í˜ì´ì§€ë„¤ì´ì…˜ í…ŒìŠ¤íŠ¸</title>
        <steps>
          1. 30ê°œ í™œë™ ìƒì„±
          2. ì²« í˜ì´ì§€ 20ê°œ ë¡œë“œ í™•ì¸
          3. Load More ë˜ëŠ” ìŠ¤í¬ë¡¤ë¡œ ë‹¤ìŒ í˜ì´ì§€
          4. ìµœì‹ ìˆœ ì •ë ¬ í™•ì¸
        </steps>
      </scenario>
      <scenario id="3" ac="8, 9, 10" priority="medium">
        <title>UI í‘œì‹œ í™•ì¸</title>
        <steps>
          1. ê° í™œë™ íƒ€ì…ë³„ ì•„ì´ì½˜ í™•ì¸
          2. ì•¡í„° ì•„ë°”íƒ€/ì´ë¦„ í‘œì‹œ í™•ì¸
          3. ìƒëŒ€ ì‹œê°„ í‘œì‹œ í™•ì¸ ("2ë¶„ ì „", "ì–´ì œ" ë“±)
        </steps>
      </scenario>
    </ideas>
  </tests>

  <designReference>
    <activityTypes>
      <type action="member_invited" icon="ğŸ“§" color="#22C55E">ë©¤ë²„ ì´ˆëŒ€</type>
      <type action="member_joined" icon="âœ…" color="#3B82F6">ë©¤ë²„ ê°€ì…</type>
      <type action="role_changed" icon="ğŸ”„" color="#F59E0B">ì—­í•  ë³€ê²½</type>
      <type action="member_removed" icon="âŒ" color="#EF4444">ê°•ì œ í‡´ì¥</type>
      <type action="member_left" icon="ğŸ‘‹" color="#A1A1AA">ìë°œì  íƒˆí‡´</type>
      <type action="team_updated" icon="âš™ï¸" color="#8B5CF6">íŒ€ ì„¤ì • ë³€ê²½</type>
      <type action="team_deleted" icon="ğŸ—‘ï¸" color="#EF4444">íŒ€ ì‚­ì œ</type>
    </activityTypes>
    <uxSpecs>
      <spec title="Activity Timeline UI">
+--------------------------------------------------------------------+
| ğŸ“§ í™ê¸¸ë™ invited ê¹€ì„œì—° as Member                        2ë¶„ ì „     |
+--------------------------------------------------------------------+
| âœ… ê¹€ì„œì—° joined the team                                 1ì‹œê°„ ì „   |
+--------------------------------------------------------------------+
| ğŸ”„ í™ê¸¸ë™ changed ë°•ì˜í¬'s role from Member to Admin       ì–´ì œ       |
+--------------------------------------------------------------------+
| âŒ í™ê¸¸ë™ removed ì´ë¯¼ìˆ˜ from the team                     3ì¼ ì „     |
+--------------------------------------------------------------------+
| âš™ï¸ í™ê¸¸ë™ updated team name to "New Name"                 1ì£¼ ì „     |
+--------------------------------------------------------------------+
                        [Load More]
      </spec>
    </uxSpecs>
    <dbSchema>
CREATE TABLE public.team_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID REFERENCES public.teams NOT NULL,
  actor_id UUID REFERENCES public.profiles NOT NULL,
  action VARCHAR(50) NOT NULL,
  target_type VARCHAR(30),  -- 'member', 'project', 'team'
  target_id UUID,
  details JSONB,            -- { "from": "MEMBER", "to": "ADMIN" }
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_team_activities_team ON public.team_activities(team_id);
CREATE INDEX idx_team_activities_created ON public.team_activities(created_at DESC);
    </dbSchema>
  </designReference>

  <apisToModify>
    <api path="app/api/teams/[teamId]/invites/route.ts" action="member_invited"/>
    <api path="app/api/invites/[token]/accept/route.ts" action="member_joined"/>
    <api path="app/api/teams/[teamId]/members/[userId]/route.ts" action="member_removed, member_left, role_changed"/>
    <api path="app/api/teams/[teamId]/route.ts" action="team_updated, team_deleted"/>
  </apisToModify>
</story-context>
