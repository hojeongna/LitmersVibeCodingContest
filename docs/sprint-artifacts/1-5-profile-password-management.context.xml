<story-context id="1-5-profile-password-management" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>프로필 &amp; 비밀번호 관리</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-profile-password-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>인증된 사용자</asA>
    <iWant>내 프로필 사진과 이름을 수정하고, 비밀번호를 변경하거나 분실 시 재설정</iWant>
    <soThat>개인 정보를 최신 상태로 유지하고 계정 보안을 관리할 수 있다</soThat>
    <tasks>
      <part id="A" title="프로필 설정 페이지 구현">
        <task n="1" title="프로필 설정 페이지 레이아웃 구현" ac="1, 4">
          <subtask n="1.1">app/(dashboard)/settings/profile/page.tsx 생성</subtask>
          <subtask n="1.2">프로필 사진 업로드 섹션 UI 구현 (아바타 원형, "Upload Photo" 버튼)</subtask>
          <subtask n="1.3">개인 정보 섹션 UI (이름 입력, 이메일 읽기 전용)</subtask>
          <subtask n="1.4">저장/취소 버튼 그룹</subtask>
          <subtask n="1.5">UX 시각 자료 참조하여 카드 기반 섹션 레이아웃</subtask>
        </task>
        <task n="2" title="프로필 사진 업로드 기능" ac="1, 2, 12">
          <subtask n="2.1">파일 input 컴포넌트 (type="file", accept="image/*")</subtask>
          <subtask n="2.2">파일 선택 시 미리보기 표시 (URL.createObjectURL)</subtask>
          <subtask n="2.3">5MB 용량 제한 검증 (클라이언트)</subtask>
          <subtask n="2.4">Supabase Storage 업로드 (avatars 버킷)</subtask>
          <subtask n="2.5">업로드 성공 시 profiles.avatar_url 업데이트</subtask>
          <subtask n="2.6">기존 이미지 있으면 교체 (덮어쓰기 또는 삭제 후 업로드)</subtask>
          <subtask n="2.7">업로드 중 로딩 상태 표시</subtask>
        </task>
        <task n="3" title="프로필 정보 수정 기능" ac="3, 4">
          <subtask n="3.1">이름 수정 폼 (react-hook-form + zod 검증)</subtask>
          <subtask n="3.2">Supabase profiles 테이블 UPDATE 호출</subtask>
          <subtask n="3.3">성공 시 Toast 표시 ("프로필이 저장되었습니다")</subtask>
          <subtask n="3.4">에러 시 Toast 표시 (에러 메시지)</subtask>
          <subtask n="3.5">취소 버튼 클릭 시 원래 값으로 복원</subtask>
        </task>
      </part>
      <part id="B" title="비밀번호 찾기 (재설정 요청)">
        <task n="4" title="비밀번호 찾기 페이지 구현" ac="5">
          <subtask n="4.1">app/(auth)/forgot-password/page.tsx 개선 (기존 파일 존재)</subtask>
          <subtask n="4.2">이메일 입력 폼 UI 검토</subtask>
          <subtask n="4.3">"Send Reset Link" 버튼</subtask>
          <subtask n="4.4">성공 메시지 UI ("이메일을 확인해주세요")</subtask>
          <subtask n="4.5">로그인 페이지 링크</subtask>
        </task>
        <task n="5" title="비밀번호 재설정 이메일 발송" ac="5, 8">
          <subtask n="5.1">supabase.auth.resetPasswordForEmail() 호출 (기존 구현됨)</subtask>
          <subtask n="5.2">redirectTo 옵션으로 /auth/update-password 지정 (기존 구현됨)</subtask>
          <subtask n="5.3">이메일 발송 중 로딩 상태</subtask>
          <subtask n="5.4">성공/실패 메시지 표시</subtask>
          <subtask n="5.5">토큰 유효기간 1시간 (Supabase 기본값)</subtask>
        </task>
      </part>
      <part id="C" title="비밀번호 재설정 (새 비밀번호 입력)">
        <task n="6" title="비밀번호 재설정 페이지 구현" ac="6, 7, 8, 10">
          <subtask n="6.1">app/(auth)/update-password/page.tsx 개선 (기존 파일 존재)</subtask>
          <subtask n="6.2">새 비밀번호 입력 폼 (비밀번호, 비밀번호 확인)</subtask>
          <subtask n="6.3">비밀번호 강도 표시기 UI</subtask>
          <subtask n="6.4">비밀번호 일치 여부 실시간 검증</subtask>
          <subtask n="6.5">supabase.auth.updateUser({ password }) 호출 (기존 구현됨)</subtask>
          <subtask n="6.6">성공 시 로그인 페이지로 리다이렉트 + 성공 메시지</subtask>
          <subtask n="6.7">토큰 만료 에러 처리 ("링크가 만료되었습니다. 다시 요청해주세요")</subtask>
        </task>
      </part>
      <part id="D" title="비밀번호 변경 (로그인 상태)">
        <task n="7" title="비밀번호 변경 섹션 구현" ac="9, 10, 11">
          <subtask n="7.1">프로필 설정 페이지 내 "Security" 섹션 추가</subtask>
          <subtask n="7.2">"Change Password" 버튼 → 모달 열기</subtask>
          <subtask n="7.3">비밀번호 변경 모달 UI (현재/새/확인 비밀번호 + 강도 표시기)</subtask>
          <subtask n="7.4">현재 비밀번호 검증 (재인증)</subtask>
          <subtask n="7.5">supabase.auth.updateUser({ password }) 호출</subtask>
          <subtask n="7.6">성공/실패 Toast 표시</subtask>
        </task>
        <task n="8" title="OAuth 사용자 비밀번호 변경 차단" ac="11">
          <subtask n="8.1">현재 사용자의 인증 방식 확인 (user.app_metadata.provider)</subtask>
          <subtask n="8.2">Google OAuth 사용자인 경우 비밀번호 변경 버튼 비활성화</subtask>
          <subtask n="8.3">안내 메시지 표시 ("Google 계정으로 로그인하여 비밀번호 변경이 불가합니다")</subtask>
        </task>
      </part>
      <part id="E" title="유틸리티 및 공통 기능">
        <task n="9" title="비밀번호 강도 측정 유틸리티" ac="10">
          <subtask n="9.1">lib/utils/password-strength.ts 생성</subtask>
          <subtask n="9.2">강도 레벨: weak (6자 미만), medium (6자 이상), strong (특수문자+숫자 포함)</subtask>
          <subtask n="9.3">PasswordStrengthIndicator 컴포넌트 (3단계 바 + 텍스트)</subtask>
        </task>
        <task n="10" title="Supabase Storage 설정" ac="2">
          <subtask n="10.1">avatars 버킷 생성 (public 또는 RLS 적용)</subtask>
          <subtask n="10.2">업로드 RLS 정책: 본인만 업로드 가능</subtask>
          <subtask n="10.3">읽기 정책: 공개 또는 팀 멤버만</subtask>
        </task>
      </part>
      <part id="F" title="테스트 및 검증">
        <task n="11" title="E2E 테스트 시나리오" ac="1-12">
          <subtask n="11.1">프로필 사진 업로드 테스트 (정상, 5MB 초과)</subtask>
          <subtask n="11.2">이름 수정 테스트</subtask>
          <subtask n="11.3">비밀번호 찾기 → 재설정 플로우 테스트</subtask>
          <subtask n="11.4">비밀번호 변경 테스트 (현재 비밀번호 틀림/맞음)</subtask>
          <subtask n="11.5">OAuth 사용자 비밀번호 변경 차단 테스트</subtask>
        </task>
      </part>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">프로필 설정 페이지(/settings/profile)에서 프로필 사진 업로드 가능</ac>
    <ac id="2">프로필 사진 업로드 시 Supabase Storage에 저장되고 URL이 profiles 테이블에 반영</ac>
    <ac id="3">이름 수정 후 저장 버튼 클릭 시 profiles 테이블 업데이트</ac>
    <ac id="4">이메일은 읽기 전용으로 표시되며 수정 불가</ac>
    <ac id="5">비밀번호 찾기 페이지(/auth/forgot-password)에서 이메일 입력 시 재설정 링크 발송</ac>
    <ac id="6">비밀번호 재설정 링크 클릭 시 /auth/update-password 페이지로 이동</ac>
    <ac id="7">새 비밀번호 입력 후 변경 성공 시 로그인 페이지로 리다이렉트</ac>
    <ac id="8">재설정 링크 1시간 후 만료 시 에러 메시지 표시</ac>
    <ac id="9">프로필 설정 내 비밀번호 변경 섹션에서 현재 비밀번호 검증 후 새 비밀번호 설정</ac>
    <ac id="10">비밀번호 변경 시 비밀번호 강도 표시기 동작</ac>
    <ac id="11">Google OAuth 사용자는 비밀번호 변경 섹션 비활성화</ac>
    <ac id="12">프로필 이미지 용량 5MB 초과 시 에러 메시지 표시</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc type="prd" path="docs/prd.md">
        <relevantSections>
          <section>FR-005: 프로필 관리 - 이름, 프로필 이미지 수정</section>
          <section>FR-006: 비밀번호 변경 - 로그인 상태에서 비밀번호 변경</section>
          <section>FR-003: 비밀번호 재설정 - 이메일 발송 기반</section>
        </relevantSections>
      </doc>
      <doc type="architecture" path="docs/architecture.md">
        <relevantSections>
          <section>Supabase Auth 통합 - 인증 플로우</section>
          <section>Supabase Storage - 프로필 이미지 저장</section>
          <section>profiles 테이블 스키마</section>
        </relevantSections>
      </doc>
      <doc type="ux-design" path="docs/ux-design-specification.md">
        <relevantSections>
          <section>Screen 7: Profile Settings - 프로필 설정 레이아웃</section>
          <section>Password Change Form (FR-006) - 비밀번호 강도 표시기 UI</section>
          <section>Color System - Linear Productivity 테마</section>
          <section>Form Patterns - Label 위치, 필수 표시, Validation 시점</section>
        </relevantSections>
        <visualReferences>
          <reference file="docs/ux-design-directions.html">Profile Settings 목업</reference>
          <reference file="docs/ux-color-themes.html">버튼, 폼, 카드 스타일</reference>
        </visualReferences>
      </doc>
      <doc type="tech-spec" path="docs/sprint-artifacts/tech-spec-epic-1.md">
        <relevantSections>
          <section>FR-005: 프로필 관리 구현 상세</section>
          <section>FR-006: 비밀번호 변경 구현 상세</section>
          <section>FR-003: 비밀번호 재설정 플로우</section>
          <section>Supabase Storage 설정</section>
          <section>Zod 스키마 - changePasswordSchema</section>
        </relevantSections>
      </doc>
    </docs>
    <code>
      <existingFiles>
        <file path="jira-lite-mvp/app/auth/forgot-password/page.tsx" status="exists">비밀번호 찾기 페이지 (개선 필요)</file>
        <file path="jira-lite-mvp/app/auth/update-password/page.tsx" status="exists">비밀번호 재설정 페이지 (개선 필요)</file>
        <file path="jira-lite-mvp/components/forgot-password-form.tsx" status="exists">비밀번호 찾기 폼 (개선 필요)</file>
        <file path="jira-lite-mvp/components/update-password-form.tsx" status="exists">비밀번호 재설정 폼 (개선 필요)</file>
        <file path="jira-lite-mvp/lib/supabase/client.ts" status="exists">Supabase 브라우저 클라이언트</file>
        <file path="jira-lite-mvp/lib/supabase/types.ts" status="exists">DB 타입 정의 (Profile 포함)</file>
        <file path="jira-lite-mvp/components/ui/button.tsx" status="exists">Button 컴포넌트</file>
        <file path="jira-lite-mvp/components/ui/input.tsx" status="exists">Input 컴포넌트</file>
        <file path="jira-lite-mvp/components/ui/label.tsx" status="exists">Label 컴포넌트</file>
        <file path="jira-lite-mvp/components/ui/card.tsx" status="exists">Card 컴포넌트</file>
      </existingFiles>
      <filesToCreate>
        <file path="jira-lite-mvp/app/(dashboard)/settings/profile/page.tsx">프로필 설정 페이지</file>
        <file path="jira-lite-mvp/components/profile-settings-form.tsx">프로필 설정 폼 컴포넌트</file>
        <file path="jira-lite-mvp/components/password-change-modal.tsx">비밀번호 변경 모달</file>
        <file path="jira-lite-mvp/components/password-strength-indicator.tsx">비밀번호 강도 표시기</file>
        <file path="jira-lite-mvp/lib/utils/password-strength.ts">비밀번호 강도 측정 유틸리티</file>
        <file path="jira-lite-mvp/lib/validations/profile.ts">프로필 관련 Zod 스키마</file>
      </filesToCreate>
      <filesToModify>
        <file path="jira-lite-mvp/components/update-password-form.tsx">비밀번호 확인 필드 추가, 강도 표시기 통합</file>
        <file path="jira-lite-mvp/components/forgot-password-form.tsx">UI 개선 (UX 디자인 반영)</file>
      </filesToModify>
    </code>
    <dependencies>
      <installed>
        <package name="@supabase/supabase-js" version="latest">Supabase 클라이언트</package>
        <package name="@supabase/ssr" version="latest">SSR용 Supabase 헬퍼</package>
        <package name="react-hook-form" version="^7.67.0">폼 상태 관리</package>
        <package name="@hookform/resolvers" version="^5.2.2">Zod + RHF 연동</package>
        <package name="zod" version="^4.1.13">스키마 유효성 검증</package>
        <package name="lucide-react" version="^0.511.0">아이콘 라이브러리</package>
        <package name="tailwind-merge" version="^3.3.0">Tailwind 클래스 병합</package>
        <package name="class-variance-authority" version="^0.7.1">컴포넌트 변형</package>
      </installed>
      <toAdd>
        <note>추가 패키지 필요 없음 - 모든 필요 패키지 설치됨</note>
      </toAdd>
      <shadcnComponents>
        <installed>button, input, label, card, badge, checkbox, dropdown-menu</installed>
        <toAdd>toast, avatar, dialog, tabs, separator</toAdd>
      </shadcnComponents>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1" source="PRD">비밀번호 최소 6자 이상, 최대 100자</constraint>
    <constraint id="C2" source="PRD">비밀번호 재설정 링크 1시간 만료</constraint>
    <constraint id="C3" source="PRD">프로필 이미지 최대 5MB</constraint>
    <constraint id="C4" source="PRD">사용자 이름 1~50자</constraint>
    <constraint id="C5" source="Architecture">JWT 토큰 24시간 만료</constraint>
    <constraint id="C6" source="PRD">Google OAuth 사용자는 비밀번호 변경 불가</constraint>
    <constraint id="C7" source="UX">비밀번호 강도: weak (6자 미만), medium (6자 이상), strong (특수문자+숫자 포함)</constraint>
  </constraints>

  <interfaces>
    <supabaseAuth>
      <method name="supabase.auth.resetPasswordForEmail">
        <params>email: string, options: { redirectTo: string }</params>
        <returns>{ error: AuthError | null }</returns>
        <usage>비밀번호 재설정 이메일 발송</usage>
      </method>
      <method name="supabase.auth.updateUser">
        <params>{ password: string }</params>
        <returns>{ data: { user: User }, error: AuthError | null }</returns>
        <usage>비밀번호 변경 (재설정 및 로그인 상태)</usage>
      </method>
      <method name="supabase.auth.getUser">
        <params>-</params>
        <returns>{ data: { user: User }, error: AuthError | null }</returns>
        <usage>현재 사용자 정보 조회 (provider 확인)</usage>
      </method>
    </supabaseAuth>
    <supabaseDB>
      <query table="profiles" operation="UPDATE">
        <fields>name, avatar_url</fields>
        <condition>id = auth.uid()</condition>
        <usage>프로필 정보 업데이트</usage>
      </query>
      <query table="profiles" operation="SELECT">
        <fields>id, name, avatar_url, created_at, updated_at</fields>
        <condition>id = auth.uid()</condition>
        <usage>현재 사용자 프로필 조회</usage>
      </query>
      <query table="teams" operation="SELECT">
        <fields>COUNT(*)</fields>
        <condition>owner_id = auth.uid()</condition>
        <usage>소유 팀 개수 확인 (계정 삭제 전 체크)</usage>
      </query>
    </supabaseDB>
    <supabaseStorage>
      <bucket name="avatars">
        <operation name="upload">
          <path>userId/filename</path>
          <options>{ upsert: true }</options>
        </operation>
        <operation name="getPublicUrl">
          <path>userId/filename</path>
        </operation>
        <operation name="remove">
          <path>userId/filename</path>
        </operation>
      </bucket>
    </supabaseStorage>
    <apiRoutes>
      <route method="POST" path="/api/auth/callback">
        <purpose>OAuth 콜백 처리 (기존)</purpose>
      </route>
    </apiRoutes>
  </interfaces>

  <tests>
    <standards>
      <standard>E2E: Chrome DevTools MCP 사용</standard>
      <standard>Unit: Vitest + React Testing Library (권장)</standard>
      <standard>모든 폼 입력에 유효성 검증 테스트</standard>
      <standard>에러 상태 UI 테스트</standard>
    </standards>
    <locations>
      <location>jira-lite-mvp/__tests__/profile/ (새로 생성)</location>
      <location>jira-lite-mvp/__tests__/auth/ (새로 생성)</location>
    </locations>
    <ideas>
      <testCase ac="1,2">프로필 사진 업로드 성공 - 이미지 선택 → 미리보기 표시 → 저장 → Storage 업로드 확인</testCase>
      <testCase ac="12">5MB 초과 이미지 업로드 시 에러 메시지 표시</testCase>
      <testCase ac="3">이름 수정 후 저장 → profiles 테이블 업데이트 확인</testCase>
      <testCase ac="4">이메일 필드가 disabled/readonly 상태인지 확인</testCase>
      <testCase ac="5">비밀번호 찾기 → 이메일 입력 → 발송 성공 메시지 표시</testCase>
      <testCase ac="6,7">재설정 링크 클릭 → 새 비밀번호 입력 → 로그인 페이지 리다이렉트</testCase>
      <testCase ac="8">만료된 토큰으로 접근 시 에러 메시지 표시</testCase>
      <testCase ac="9">현재 비밀번호 틀림 → 에러 표시, 맞음 → 변경 성공</testCase>
      <testCase ac="10">비밀번호 입력 시 강도 표시기 업데이트 (weak/medium/strong)</testCase>
      <testCase ac="11">Google OAuth 사용자 → 비밀번호 변경 버튼 비활성화 + 안내 메시지</testCase>
      <edgeCase>비밀번호 100자 초과 시 유효성 에러</edgeCase>
      <edgeCase>이름 빈 문자열 또는 50자 초과 시 유효성 에러</edgeCase>
      <edgeCase>새 비밀번호와 확인 비밀번호 불일치 시 에러</edgeCase>
      <edgeCase>프로필 이미지가 아닌 파일 업로드 시도 (accept 속성 검증)</edgeCase>
    </ideas>
  </tests>

  <implementationNotes>
    <note priority="high">기존 forgot-password, update-password 페이지가 있으므로 개선 작업 수행</note>
    <note priority="high">비밀번호 강도 표시기는 재사용 가능한 컴포넌트로 분리</note>
    <note priority="high">Google OAuth 사용자 확인: user.app_metadata.provider === 'google'</note>
    <note priority="medium">프로필 설정 페이지는 탭 구조로 Profile/Security/Preferences 분리 (UX 명세)</note>
    <note priority="medium">Toast 컴포넌트 설치 필요: npx shadcn@latest add toast</note>
    <note priority="medium">Avatar 컴포넌트 설치 필요: npx shadcn@latest add avatar</note>
    <note priority="low">Supabase Storage avatars 버킷 생성 및 RLS 정책 적용 필요</note>
  </implementationNotes>

  <workflowDiagrams>
    <diagram name="비밀번호 재설정 플로우">
      User → ForgotPasswordForm → supabase.auth.resetPasswordForEmail()
           → Supabase 이메일 발송 (1시간 유효 토큰)
           → User: 이메일 링크 클릭
           → /auth/update-password?code=xxx
           → UpdatePasswordForm → supabase.auth.updateUser({ password })
           → 로그인 페이지 리다이렉트
    </diagram>
    <diagram name="프로필 이미지 업로드 플로우">
      User → 파일 선택 → 미리보기 표시
           → 저장 버튼 클릭
           → 5MB 검증 (실패 시 에러)
           → Supabase Storage.upload()
           → Storage URL 획득
           → profiles.avatar_url UPDATE
           → 성공 Toast
    </diagram>
    <diagram name="비밀번호 변경 플로우 (로그인 상태)">
      User → 프로필 설정 → Security 탭
           → "Change Password" 버튼 → 모달 열기
           → 현재 비밀번호 입력 → 재인증 (signInWithPassword)
           → 새 비밀번호 입력 (강도 표시기)
           → 확인 비밀번호 입력 (일치 검증)
           → supabase.auth.updateUser({ password })
           → 성공 Toast → 모달 닫기
    </diagram>
  </workflowDiagrams>
</story-context>
