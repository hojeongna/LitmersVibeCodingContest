<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: 3-4-issue-detail-edit
  Generated: 2025-11-29
  Epic: 3 - 프로젝트 & 이슈 관리
  FR Coverage: FR-031, FR-032, FR-033, FR-034, FR-035, FR-039
-->
<story-context story-key="3-4-issue-detail-edit" epic="3">
  <meta>
    <title>이슈 상세 &amp; 수정</title>
    <status>drafted</status>
    <fr-coverage>FR-031, FR-032, FR-033, FR-034, FR-035, FR-039</fr-coverage>
    <depends-on>3-3-issue-create-list</depends-on>
  </meta>

  <!-- ============================================
       SECTION 1: PRD Requirements
       ============================================ -->
  <prd-requirements>
    <requirement id="FR-031" priority="P0">
      <title>이슈 상세 조회</title>
      <description>
        - ID, 제목, 설명, 상태, 우선순위, 담당자, 마감일, 라벨, 생성일, 수정일 표시
        - 설명은 마크다운 렌더링
        - 상세 패널은 우측 슬라이드 패널 (400px)
      </description>
    </requirement>
    <requirement id="FR-032" priority="P0">
      <title>이슈 수정</title>
      <description>
        - 팀 멤버는 제목, 설명, 담당자, 마감일, 상태, 우선순위, 라벨 수정 가능
        - 필드 수정 시 즉시 UI 반영 (낙관적 업데이트)
      </description>
    </requirement>
    <requirement id="FR-033" priority="P0">
      <title>상태 변경</title>
      <description>
        - 드롭다운 또는 Drag &amp; Drop으로 상태 변경 (이 스토리: 드롭다운)
        - 상태 변경 시 자동으로 히스토리에 기록
      </description>
    </requirement>
    <requirement id="FR-034" priority="P1">
      <title>담당자 지정</title>
      <description>
        - 담당자는 팀 멤버 목록에서만 선택 가능
        - "Assign to me" 버튼으로 빠른 자기 할당
      </description>
    </requirement>
    <requirement id="FR-035" priority="P1">
      <title>이슈 삭제</title>
      <description>
        - 삭제 권한: 이슈 소유자, 프로젝트 소유자, 팀 OWNER, 팀 ADMIN
        - 삭제 시 확인 모달 표시
        - Soft Delete 처리 (deleted_at 필드)
      </description>
    </requirement>
    <requirement id="FR-039" priority="P1">
      <title>변경 히스토리</title>
      <description>
        - 상태, 담당자, 우선순위, 제목, 마감일 변경 시 자동 기록
        - 변경 항목, 이전 값, 새 값, 변경자, 변경 일시 저장
      </description>
    </requirement>
  </prd-requirements>

  <!-- ============================================
       SECTION 2: Architecture Context
       ============================================ -->
  <architecture>
    <api-patterns>
      <pattern name="Response Format">
        <success>{ success: true, data: {...} }</success>
        <error>{ success: false, error: { code: 'ERROR_CODE', message: '...' } }</error>
      </pattern>
      <pattern name="Optimistic Update">
        TanStack Query useMutation with onMutate/onError/onSettled
      </pattern>
    </api-patterns>

    <database-schema>
      <table name="issues" reference="3-3-issue-create-list.context.xml"/>
      <table name="issue_history">
        <column name="id" type="UUID" primary-key="true"/>
        <column name="issue_id" type="UUID" not-null="true" references="issues"/>
        <column name="changed_by" type="UUID" not-null="true" references="profiles"/>
        <column name="field_name" type="VARCHAR(50)" not-null="true" comment="status|assignee|priority|title|due_date"/>
        <column name="old_value" type="TEXT" nullable="true"/>
        <column name="new_value" type="TEXT" nullable="true"/>
        <column name="created_at" type="TIMESTAMPTZ" default="NOW()"/>
        <index name="idx_issue_history_issue" columns="issue_id"/>
      </table>
    </database-schema>

    <delete-permission-logic>
      <rule>이슈 소유자 (issue.owner_id === currentUser.id)</rule>
      <rule>프로젝트 소유자 (project.owner_id === currentUser.id)</rule>
      <rule>팀 OWNER (team_members.role === 'OWNER')</rule>
      <rule>팀 ADMIN (team_members.role === 'ADMIN')</rule>
    </delete-permission-logic>
  </architecture>

  <!-- ============================================
       SECTION 3: UX Design Specification
       ============================================ -->
  <ux-design source="docs/ux-design-specification.md, docs/ux-design-directions.html">
    <issue-detail-panel>
      <layout>
        <type>Right Slide Panel (Sheet)</type>
        <width>400px</width>
        <dismiss>X 버튼, ESC 키, 외부 클릭</dismiss>
      </layout>
      <ascii-diagram><![CDATA[
+------------------------------------------+
| JL-8                              [X]    |
+------------------------------------------+
| Build kanban board drag & drop           |
|                                          |
| [AI Panel - Epic 5에서 구현]             |
|                                          |
| Description                              |
| Implement drag and drop functionality... |
|                                          |
| Status: [In Progress ▼]                  |
| Priority: [HIGH ▼]                       |
| Assignee: [Hojeong ▼] [Assign to me]     |
| Due Date: [Dec 18]                       |
| Labels: [Feature] [+]                    |
|                                          |
| Created: Nov 28, 2025                    |
| Updated: Nov 29, 2025                    |
|                                          |
| [Subtasks - Story 3-6에서 구현]          |
| [History - Story 3-6에서 구현]           |
| [Comments - Epic 4에서 구현]             |
|                                          |
| [Delete Issue] (권한 있을 때만)          |
+------------------------------------------+
      ]]></ascii-diagram>
    </issue-detail-panel>

    <inline-editing>
      <title-edit>
        <trigger>제목 클릭</trigger>
        <save>Enter 또는 blur</save>
        <cancel>Escape</cancel>
      </title-edit>
      <dropdown-edit>
        <fields>상태, 우선순위, 담당자</fields>
        <behavior>선택 즉시 API 호출 + 낙관적 업데이트</behavior>
      </dropdown-edit>
    </inline-editing>

    <delete-confirmation-modal>
      <ascii-diagram><![CDATA[
+------------------------------------------+
| Delete Issue                        [X]  |
+------------------------------------------+
| Are you sure you want to delete          |
| "Build kanban board drag & drop"?        |
|                                          |
| This action cannot be undone.            |
|                                          |
| [Cancel]               [Delete Issue]    |
+------------------------------------------+
      ]]></ascii-diagram>
      <button-style>Destructive (bg-red-500)</button-style>
    </delete-confirmation-modal>

    <color-theme reference="3-3-issue-create-list.context.xml">
      <surface hex="#FFFFFF">패널 배경</surface>
      <border hex="#E4E4E7">구분선</border>
      <text-primary hex="#18181B">제목</text-primary>
      <text-secondary hex="#71717A">메타 정보</text-secondary>
    </color-theme>
  </ux-design>

  <!-- ============================================
       SECTION 4: Existing Codebase Context
       ============================================ -->
  <existing-code>
    <components-from-story-3-3>
      <component path="components/ui/priority-badge.tsx">우선순위 배지</component>
      <component path="components/ui/label-tag.tsx">라벨 태그</component>
      <component path="components/issues/issue-card.tsx">이슈 카드 (Story 3-3에서 생성)</component>
    </components-from-story-3-3>

    <component path="jira-lite-mvp/components/ui/sheet.tsx">
      <description>우측 슬라이드 패널 (shadcn/ui)</description>
      <usage>
        <![CDATA[
import { Sheet, SheetContent, SheetHeader, SheetTitle } from "@/components/ui/sheet"

<Sheet open={open} onOpenChange={setOpen}>
  <SheetContent side="right" className="w-[400px]">
    <SheetHeader>
      <SheetTitle>JL-8</SheetTitle>
    </SheetHeader>
    {/* content */}
  </SheetContent>
</Sheet>
        ]]>
      </usage>
    </component>

    <component path="jira-lite-mvp/components/ui/select.tsx">
      <description>Select 컴포넌트 (상태, 우선순위, 담당자 드롭다운)</description>
    </component>

    <component path="jira-lite-mvp/components/ui/dialog.tsx">
      <description>Dialog 컴포넌트 (삭제 확인 모달)</description>
    </component>

    <component path="jira-lite-mvp/components/ui/avatar.tsx">
      <description>Avatar 컴포넌트 (담당자 표시)</description>
    </component>

    <types path="jira-lite-mvp/lib/supabase/types.ts">
      <exports>
        <export name="Issue"/>
        <export name="IssueHistory"/>
        <export name="Profile"/>
        <export name="Status"/>
        <export name="Label"/>
        <export name="TeamMember"/>
      </exports>
    </types>
  </existing-code>

  <!-- ============================================
       SECTION 5: Files to Create
       ============================================ -->
  <files-to-create>
    <api>
      <file path="app/api/issues/[issueId]/route.ts">
        <purpose>이슈 상세 조회(GET), 수정(PUT), 삭제(DELETE)</purpose>
        <methods>
          <method name="GET">
            <validation>팀 멤버십 검증</validation>
            <response>이슈 + 라벨 + 담당자 + 상태 + 프로젝트키 JOIN</response>
          </method>
          <method name="PUT">
            <body>title?, description?, priority?, statusId?, assigneeId?, dueDate?, labelIds?</body>
            <validation>
              - 팀 멤버십 검증
              - 라벨 최대 5개
            </validation>
            <side-effects>
              - 변경된 필드마다 issue_history에 INSERT
              - updated_at 갱신
            </side-effects>
          </method>
          <method name="DELETE">
            <validation>
              - 이슈 소유자 OR 프로젝트 소유자 OR 팀 OWNER OR 팀 ADMIN
            </validation>
            <logic>Soft Delete (deleted_at = NOW())</logic>
          </method>
        </methods>
      </file>
    </api>

    <components>
      <file path="components/issues/issue-detail-panel.tsx">
        <purpose>이슈 상세 슬라이드 패널</purpose>
        <sections>
          <section>헤더 (이슈 ID, 닫기 버튼)</section>
          <section>제목 (인라인 편집)</section>
          <section>설명 (마크다운 렌더링 + 편집 모드)</section>
          <section>메타데이터 (상태, 우선순위, 담당자, 마감일, 라벨)</section>
          <section>생성일/수정일</section>
          <section>삭제 버튼 (권한 있을 때만)</section>
        </sections>
      </file>
      <file path="components/issues/inline-title-editor.tsx">
        <purpose>인라인 제목 편집 컴포넌트</purpose>
        <behavior>클릭 → input 모드, Enter/blur → 저장, Escape → 취소</behavior>
      </file>
      <file path="components/issues/assignee-select.tsx">
        <purpose>담당자 선택 드롭다운 + Assign to me 버튼</purpose>
        <features>
          <feature>팀 멤버 목록 표시</feature>
          <feature>아바타 + 이름</feature>
          <feature>"Assign to me" 버튼</feature>
          <feature>"Unassigned" 옵션</feature>
        </features>
      </file>
      <file path="components/issues/delete-issue-modal.tsx">
        <purpose>이슈 삭제 확인 모달</purpose>
        <elements>
          <element>경고 메시지</element>
          <element>취소 버튼</element>
          <element>삭제 버튼 (Destructive 스타일)</element>
        </elements>
      </file>
    </components>

    <hooks>
      <file path="hooks/use-issues.ts" mode="extend">
        <add-exports>
          <hook name="useIssue">개별 이슈 상세 조회</hook>
          <hook name="useUpdateIssue">이슈 수정 mutation (낙관적 업데이트)</hook>
          <hook name="useDeleteIssue">이슈 삭제 mutation</hook>
        </add-exports>
      </file>
      <file path="hooks/use-team-members.ts">
        <purpose>팀 멤버 목록 조회 (담당자 선택용)</purpose>
        <exports>
          <hook name="useTeamMembers">teamId로 멤버 목록 조회</hook>
        </exports>
      </file>
    </hooks>

    <reuse-from-story-3-2>
      <component path="components/shared/markdown-renderer.tsx">
        설명 마크다운 렌더링
      </component>
    </reuse-from-story-3-2>
  </files-to-create>

  <!-- ============================================
       SECTION 6: History Recording Logic
       ============================================ -->
  <history-recording>
    <trigger>PUT /api/issues/[issueId]에서 필드 변경 감지</trigger>
    <fields-to-track>
      <field name="status" old-value-format="status.name" new-value-format="status.name"/>
      <field name="assignee" old-value-format="profile.name or null" new-value-format="profile.name or null"/>
      <field name="priority" old-value-format="HIGH|MEDIUM|LOW" new-value-format="HIGH|MEDIUM|LOW"/>
      <field name="title" old-value-format="string" new-value-format="string"/>
      <field name="due_date" old-value-format="YYYY-MM-DD or null" new-value-format="YYYY-MM-DD or null"/>
    </fields-to-track>
    <sql-example><![CDATA[
INSERT INTO issue_history (issue_id, changed_by, field_name, old_value, new_value)
VALUES ($1, $2, 'status', 'Backlog', 'In Progress');
    ]]></sql-example>
  </history-recording>

  <!-- ============================================
       SECTION 7: Acceptance Criteria Checklist
       ============================================ -->
  <acceptance-criteria>
    <ac id="1" status="pending">이슈 상세 패널에서 ID, 제목, 설명, 상태, 우선순위, 담당자, 마감일, 라벨, 생성일, 수정일 표시</ac>
    <ac id="2" status="pending">이슈 설명이 마크다운으로 렌더링</ac>
    <ac id="3" status="pending">팀 멤버는 제목, 설명, 담당자, 마감일, 상태, 우선순위, 라벨 수정 가능</ac>
    <ac id="4" status="pending">상태 변경은 드롭다운으로 가능</ac>
    <ac id="5" status="pending">담당자는 팀 멤버 목록에서만 선택 가능</ac>
    <ac id="6" status="pending">"Assign to me" 버튼으로 자기 할당</ac>
    <ac id="7" status="pending">삭제 권한: 이슈 소유자, 프로젝트 소유자, 팀 OWNER, 팀 ADMIN</ac>
    <ac id="8" status="pending">이슈 삭제 시 확인 모달 + Soft Delete</ac>
    <ac id="9" status="pending">필드 수정 시 즉시 UI 반영 (낙관적 업데이트)</ac>
    <ac id="10" status="pending">상태 변경 시 자동으로 히스토리에 기록</ac>
  </acceptance-criteria>

  <!-- ============================================
       SECTION 8: Dependencies
       ============================================ -->
  <dependencies>
    <story-dependency id="3-3-issue-create-list" status="drafted" required="true">
      이슈 카드, PriorityBadge, LabelTag, useIssues 훅
    </story-dependency>
    <story-dependency id="3-2-project-advanced-features" status="drafted">
      마크다운 렌더러
    </story-dependency>
    <package-dependency name="react-markdown" version="^9.x">마크다운 렌더링</package-dependency>
  </dependencies>
</story-context>
