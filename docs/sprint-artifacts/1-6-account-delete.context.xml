<story-context id="1-6-account-delete" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>6</storyId>
    <title>계정 삭제 (Account Deletion)</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-6-account-delete.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>인증된 사용자</asA>
    <iWant>내 계정과 관련 데이터를 영구적으로 삭제</iWant>
    <soThat>더 이상 서비스를 사용하지 않을 때 개인정보를 완전히 제거할 수 있다</soThat>
    <tasks>
      <partA name="계정 삭제 UI (프로필 설정 페이지)">
        <task id="1">Security 섹션 Danger Zone UI 구현 (AC: 1, 2)
          <subtask>1.1 프로필 설정 페이지 `/settings/profile`에 Danger Zone 섹션 추가</subtask>
          <subtask>1.2 빨간 배경(`#FEF2F2`), 빨간 테두리(`#FECACA`)로 위험 영역 스타일링</subtask>
          <subtask>1.3 "Delete Account" 제목과 설명 텍스트</subtask>
          <subtask>1.4 빨간 "Delete Account" 버튼 (`bg-[#EF4444]`, `hover:bg-[#DC2626]`)</subtask>
          <subtask>1.5 버튼 클릭 시 삭제 확인 모달 열기</subtask>
        </task>
        <task id="2">계정 삭제 확인 모달 UI 구현 (AC: 2, 3, 4, 5, 6, 7)
          <subtask>2.1 `components/settings/delete-account-modal.tsx` 생성</subtask>
          <subtask>2.2 모달 헤더: 경고 아이콘 + "Delete Account" 제목 (빨간색)</subtask>
          <subtask>2.3 삭제 경고 메시지: "This action cannot be undone"</subtask>
          <subtask>2.4 삭제될 항목 목록 UI (빨간 배경 박스)</subtask>
          <subtask>2.5 팀 Owner 경고 UI (노란 배경 박스, 조건부 표시)</subtask>
          <subtask>2.6 비밀번호 입력 필드 (일반 사용자용)</subtask>
          <subtask>2.7 "DELETE" 텍스트 입력 필드 (OAuth 사용자용)</subtask>
          <subtask>2.8 삭제 버튼 (조건 충족 시에만 활성화)</subtask>
          <subtask>2.9 취소 버튼</subtask>
        </task>
      </partA>
      <partB name="계정 삭제 로직">
        <task id="3">팀 소유권 확인 로직 (AC: 4, 7)
          <subtask>3.1 현재 사용자가 소유한 팀 목록 조회 함수</subtask>
          <subtask>3.2 `teams` 테이블에서 `owner_id = currentUserId` 조회</subtask>
          <subtask>3.3 소유 팀이 있으면 팀 목록과 함께 경고 표시</subtask>
          <subtask>3.4 소유 팀이 있으면 삭제 버튼 비활성화</subtask>
        </task>
        <task id="4">본인 확인 로직 (AC: 5, 6)
          <subtask>4.1 일반 사용자: 비밀번호 재인증 (`signInWithPassword`)</subtask>
          <subtask>4.2 OAuth 사용자: "DELETE" 텍스트 정확히 입력 확인</subtask>
          <subtask>4.3 사용자 인증 방식 확인 (`user.app_metadata.provider`)</subtask>
          <subtask>4.4 조건 충족 시에만 삭제 버튼 활성화</subtask>
        </task>
        <task id="5">계정 삭제 API Route 구현 (AC: 8, 9, 10, 12)
          <subtask>5.1 `app/api/account/delete/route.ts` 생성</subtask>
          <subtask>5.2 요청 검증 (비밀번호 또는 DELETE 텍스트)</subtask>
          <subtask>5.3 팀 Owner 여부 재확인 (서버 측 검증)</subtask>
          <subtask>5.4 댓글 익명화 처리 (comments.author_id = null, author_name = '삭제된 사용자')</subtask>
          <subtask>5.5 team_members에서 해당 사용자 삭제</subtask>
          <subtask>5.6 profiles에서 해당 사용자 삭제</subtask>
          <subtask>5.7 Supabase Admin API로 Auth 사용자 삭제</subtask>
          <subtask>5.8 Storage에서 사용자 아바타 삭제 (있는 경우)</subtask>
        </task>
        <task id="6">삭제 완료 처리 (AC: 11)
          <subtask>6.1 삭제 성공 시 세션 종료</subtask>
          <subtask>6.2 로그인 페이지로 리다이렉트 (`/auth/login?deleted=true`)</subtask>
          <subtask>6.3 로그인 페이지에서 쿼리 파라미터 확인 후 안내 메시지 표시</subtask>
          <subtask>6.4 에러 발생 시 에러 메시지 표시 및 모달 유지</subtask>
        </task>
      </partB>
      <partC name="데이터베이스 정책">
        <task id="7">댓글 익명화 정책 구현 (AC: 12)
          <subtask>7.1 `comments` 테이블에 `author_name` 컬럼 추가 (또는 기존 활용)</subtask>
          <subtask>7.2 삭제 시 `author_id = NULL`, `author_name = '삭제된 사용자'`로 업데이트</subtask>
          <subtask>7.3 댓글 표시 시 `author_id`가 NULL이면 익명화된 이름 표시</subtask>
        </task>
        <task id="8">CASCADE 삭제 정책 검토 (AC: 9, 10)
          <subtask>8.1 `profiles` 테이블 삭제 시 관련 데이터 처리 확인</subtask>
          <subtask>8.2 `team_members`에서 해당 사용자 레코드 삭제</subtask>
          <subtask>8.3 `issues` 테이블에서 assignee_id, reporter_id 처리 (NULL로 설정 또는 유지)</subtask>
          <subtask>8.4 `notifications` 테이블에서 해당 사용자 관련 레코드 삭제</subtask>
        </task>
      </partC>
      <partD name="테스트 및 검증">
        <task id="9">E2E 테스트 시나리오 (AC: 1-12)
          <subtask>9.1 일반 사용자 계정 삭제 플로우 테스트</subtask>
          <subtask>9.2 OAuth 사용자 계정 삭제 플로우 테스트</subtask>
          <subtask>9.3 팀 Owner 삭제 차단 테스트</subtask>
          <subtask>9.4 잘못된 비밀번호 입력 시 에러 테스트</subtask>
          <subtask>9.5 "DELETE" 텍스트 불일치 시 버튼 비활성화 테스트</subtask>
          <subtask>9.6 삭제 후 댓글 익명화 확인 테스트</subtask>
        </task>
      </partD>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" fr="FR-007">프로필 설정 페이지 Security 섹션에 "Delete Account" 버튼 표시 (위험 영역으로 시각적 구분)</ac>
    <ac id="2" fr="FR-007">"Delete Account" 버튼 클릭 시 삭제 확인 모달 표시</ac>
    <ac id="3" fr="FR-007">삭제 확인 모달에서 삭제될 항목 목록 명확히 표시 (프로필, 댓글, 활동 히스토리, 팀 멤버십)</ac>
    <ac id="4" fr="FR-007">사용자가 소유한 팀이 있으면 경고 메시지 표시 ("팀 소유권을 이전하거나 팀을 삭제해야 합니다")</ac>
    <ac id="5" fr="FR-007">비밀번호 입력 필드로 본인 확인 필수 (OAuth 사용자는 "DELETE" 텍스트 입력)</ac>
    <ac id="6" fr="FR-007">"DELETE" 텍스트를 정확히 입력해야 삭제 버튼 활성화</ac>
    <ac id="7" fr="FR-007">팀 Owner인 경우 삭제 버튼 비활성화 및 안내 메시지 표시</ac>
    <ac id="8" fr="FR-007">삭제 실행 시 Supabase Auth에서 사용자 삭제</ac>
    <ac id="9" fr="FR-007">삭제 실행 시 profiles 테이블에서 해당 사용자 데이터 삭제 (CASCADE 또는 트리거)</ac>
    <ac id="10" fr="FR-007">삭제 실행 시 team_members 테이블에서 해당 사용자의 멤버십 제거</ac>
    <ac id="11" fr="FR-007">삭제 성공 시 로그인 페이지로 리다이렉트 및 안내 메시지 표시</ac>
    <ac id="12" fr="FR-007">삭제된 사용자의 댓글은 "삭제된 사용자"로 표시 (익명화)</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="계정 삭제 플로우 (FR-007)">
        계정 삭제 플로우: 소유 팀 확인 → 비밀번호 재확인 → Soft Delete (profiles.deleted_at = NOW()) → 세션 종료 → 로그인 페이지 리다이렉트
      </doc>
      <doc path="docs/sprint-artifacts/1-6-account-delete.md" title="Story 1.6" section="Dev Notes">
        UX 시각 자료, 아키텍처 패턴, Supabase API 사용법, 컴포넌트 구조, 스타일 참조 상세 가이드
      </doc>
      <doc path="docs/ux-design-directions.html" title="UX Design Mockups" section="Profile Screen - Delete Account Modal">
        Profile 탭: Danger Zone 레이아웃, Delete Account 모달 인터랙티브 UI 목업. 빨간 배경/테두리 Danger Zone, 노란 배경 팀 Owner 경고 박스
      </doc>
      <doc path="docs/ux-color-themes.html" title="Color Theme Visualizer" section="Semantic Colors / Buttons">
        Error/Destructive 색상: #EF4444 (Red 500), Hover: #DC2626 (Red 600), Error BG: #FEF2F2, Error Border: #FECACA, Warning: #F59E0B
      </doc>
    </docs>
    <code>
      <file path="jira-lite-mvp/components/ui/dialog.tsx" kind="component" symbol="Dialog, DialogContent, DialogHeader, DialogFooter, DialogTitle, DialogDescription" reason="계정 삭제 확인 모달 기반 컴포넌트 - 재사용">
      </file>
      <file path="jira-lite-mvp/components/ui/button.tsx" kind="component" symbol="Button, buttonVariants" reason="destructive variant 사용 가능 - 삭제 버튼 스타일링">
      </file>
      <file path="jira-lite-mvp/components/ui/input.tsx" kind="component" symbol="Input" reason="비밀번호/DELETE 텍스트 입력 필드">
      </file>
      <file path="jira-lite-mvp/app/auth/login/page.tsx" kind="page" symbol="LoginPage" reason="삭제 후 리다이렉트 대상, ?deleted=true 쿼리 파라미터 처리 필요">
      </file>
      <file path="jira-lite-mvp/app/auth/confirm/route.ts" kind="route" symbol="GET" reason="Supabase Auth 콜백 패턴 참조">
      </file>
    </code>
    <dependencies>
      <npm>
        <package name="@supabase/supabase-js" version="latest">Supabase 클라이언트 - Auth Admin API 사용</package>
        <package name="@supabase/ssr" version="latest">SSR용 Supabase 헬퍼</package>
        <package name="zod" version="^4.1.13">스키마 유효성 검증 - deleteAccountSchema</package>
        <package name="react-hook-form" version="^7.67.0">폼 상태 관리</package>
        <package name="@hookform/resolvers" version="^5.2.2">Zod + RHF 연동</package>
        <package name="@radix-ui/react-dialog" version="^1.1.15">모달 컴포넌트</package>
        <package name="lucide-react" version="^0.511.0">아이콘 (AlertTriangle, Trash2)</package>
        <package name="sonner" version="^2.0.7">Toast 알림</package>
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="tech-spec-epic-1.md" type="security">
      Soft Delete 패턴: 삭제 시 deleted_at 타임스탬프 기록, 조회 시 deleted_at IS NULL 조건 필수
    </constraint>
    <constraint source="tech-spec-epic-1.md" type="security">
      RLS 정책: 자신의 프로필만 조회/수정 가능 (auth.uid() = id AND deleted_at IS NULL)
    </constraint>
    <constraint source="story" type="business">
      팀 Owner인 경우 계정 삭제 불가 - 소유권 이전 또는 팀 삭제 후에만 가능
    </constraint>
    <constraint source="story" type="security">
      본인 확인 필수: 일반 사용자는 비밀번호 재인증, OAuth 사용자는 "DELETE" 텍스트 입력
    </constraint>
    <constraint source="story" type="data">
      댓글 익명화: 삭제된 사용자의 댓글은 author_id = NULL, author_name = '삭제된 사용자'로 처리
    </constraint>
    <constraint source="CLAUDE.md" type="pattern">
      API Response 형식: { success: true, data: {...} } 또는 { success: false, error: { code, message } }
    </constraint>
    <constraint source="tech-spec-epic-1.md" type="env">
      SUPABASE_SERVICE_ROLE_KEY 환경변수 필수 - Supabase Admin API (사용자 삭제) 사용에 필요
    </constraint>
  </constraints>

  <interfaces>
    <interface name="DELETE /api/account/delete" kind="REST endpoint">
      <signature>POST /api/account/delete</signature>
      <request>{ password?: string, deleteText: string }</request>
      <response>{ success: boolean } | { success: false, error: { code: string, message: string } }</response>
      <path>app/api/account/delete/route.ts</path>
    </interface>
    <interface name="supabase.auth.admin.deleteUser" kind="Supabase Admin API">
      <signature>supabaseAdmin.auth.admin.deleteUser(userId: string)</signature>
      <description>Supabase Auth에서 사용자 완전 삭제 - service_role 키 필요</description>
    </interface>
    <interface name="supabase.auth.signInWithPassword" kind="Supabase Client API">
      <signature>supabase.auth.signInWithPassword({ email, password })</signature>
      <description>비밀번호 재인증에 사용 - 현재 비밀번호 검증</description>
    </interface>
    <interface name="user.app_metadata.provider" kind="Supabase User Object">
      <signature>user.app_metadata?.provider</signature>
      <description>OAuth 제공자 확인 - 'google', 'github' 등 또는 undefined (이메일/비밀번호)</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest + React Testing Library for unit/integration tests. Chrome DevTools MCP for E2E testing.
      테스트 파일 위치: __tests__/ 또는 *.test.tsx 동일 디렉토리
    </standards>
    <locations>
      <location>jira-lite-mvp/__tests__/</location>
      <location>jira-lite-mvp/**/*.test.tsx</location>
    </locations>
    <ideas>
      <idea ac="1,2">Danger Zone 섹션 렌더링 테스트 - 빨간 배경/테두리 스타일 확인</idea>
      <idea ac="2,3">Delete Account 모달 열기 및 삭제될 항목 목록 표시 확인</idea>
      <idea ac="4,7">팀 Owner 경고 표시 및 삭제 버튼 비활성화 테스트</idea>
      <idea ac="5">일반 사용자 비밀번호 입력 필드 표시, OAuth 사용자 DELETE 텍스트 입력 필드 표시</idea>
      <idea ac="6">"DELETE" 텍스트 입력 시 삭제 버튼 활성화 상태 변경 테스트</idea>
      <idea ac="8,9,10">계정 삭제 API 호출 후 DB에서 사용자 데이터 삭제 확인</idea>
      <idea ac="11">삭제 후 /auth/login?deleted=true 리다이렉트 확인</idea>
      <idea ac="12">삭제된 사용자 댓글 익명화 ('삭제된 사용자') 표시 확인</idea>
    </ideas>
  </tests>

  <uxReference>
    <colorTheme name="Linear Productivity">
      <color name="Primary" hex="#5B5FC7" usage="주요 버튼, 링크"/>
      <color name="Error/Destructive" hex="#EF4444" usage="삭제 버튼, 에러 메시지"/>
      <color name="Error Hover" hex="#DC2626" usage="삭제 버튼 호버"/>
      <color name="Error Background" hex="#FEF2F2" usage="Danger Zone 배경, 삭제될 항목 목록 배경"/>
      <color name="Error Border" hex="#FECACA" usage="Danger Zone 테두리"/>
      <color name="Warning Background" hex="#FEF3C7" usage="팀 Owner 경고 박스 배경"/>
      <color name="Warning Text" hex="#92400E" usage="팀 Owner 경고 텍스트"/>
      <color name="Text Primary" hex="#18181B" usage="제목, 본문"/>
      <color name="Text Secondary" hex="#71717A" usage="설명, 메타정보"/>
    </colorTheme>
    <layoutReference>
      <dangerZone>
        Profile Settings > Security 섹션 하단에 위치
        빨간 배경(#FEF2F2), 빨간 테두리(#FECACA), 8px border-radius
        "Delete Account" 제목 + 설명 + 빨간 삭제 버튼
      </dangerZone>
      <deleteModal width="480px">
        헤더: 경고 아이콘(⚠️) + "Delete Account" (빨간색, #EF4444)
        경고 메시지: "This action cannot be undone"
        삭제될 항목 박스 (빨간 배경): 프로필, 댓글, 팀 멤버십
        팀 Owner 경고 박스 (노란 배경, 조건부): 소유 팀 목록
        입력 필드: 비밀번호 (일반) / DELETE 텍스트 (OAuth)
        버튼: Cancel (secondary) / Delete My Account (destructive, 조건부 활성화)
      </deleteModal>
    </layoutReference>
  </uxReference>
</story-context>
